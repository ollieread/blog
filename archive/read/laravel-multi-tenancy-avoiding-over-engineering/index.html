<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <title>Laravel multi-tenancy, avoiding over engineering | ollieread.com</title>

    <link rel="home" href="https://ollieread.com">
    <link rel="icon" href="/favicon.ico">
    <link href="/blog/feed.atom" type="application/atom+xml" rel="alternate" title="ollieread.com Atom Feed">

    <link rel="stylesheet" href="/assets/build/css/app.css?id=9d2bb2ccf5ec74454d4e6db68f8d60df">

    
        <!--  Metadata -->
    <meta name="description" content="" />

    <!-- OpenGraph Metadata -->
    <meta name="og:type" property="og:type" content="article" />
    <meta name="og:title" property="og:title" content="Laravel multi-tenancy, avoiding over engineering"/>
    <meta name="og:url" property="og:url" content="https://ollieread.com/archive/read/laravel-multi-tenancy-avoiding-over-engineering" />
    <meta name="og:locale" property="og:locale" content="en_GB" />
    <meta name="og:site_name" property="og:site_name" content="ollieread.com"/>
    <meta name="og:image" property="og:image" content="/assets/images/page-thumbnail.png" />

    <!-- Article Metadata -->
    <meta name="article:published_time" property="article:published_time" content="2018-08-06T16:30:00+00:00"/>
    <meta name="article:section" property="article:section" content="tutorials"/>

    <!-- Twitter Metadata -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:creator" content="@ollieread" />
</head>

<body class="antialiased">

<header class="header">

    <nav class="header__links">
    <a href="https://twitter.com/ollieread" target="__blank" class="header__link header__link--twitter">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="100%" height="100%">
            <path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/>
        </svg>
    </a>
    <a href="https://phpc.social/@ollieread" target="__blank" class="header__link header__link--mastodon" rel="me">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="100%" height="100%">
            <!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
            <path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/>
        </svg>
    </a>
    <a href="https://github.com/ollieread" target="__blank" class="header__link header__link--github">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" width="100%" height="100%">
            <!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
            <path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/>
        </svg>
    </a>
    <a href="https://youtube.com/@olliecodes" target="__blank" class="header__link header__link--youtube">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" width="100%" height="100%">
            <!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
            <path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/>
        </svg>
    </a>
    <a href="https://discord.gg/rtQF6jCTk3" target="__blank" class="header__link header__link--discord">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" width="100%" height="100%">
            <!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
            <path d="M524.531,69.836a1.5,1.5,0,0,0-.764-.7A485.065,485.065,0,0,0,404.081,32.03a1.816,1.816,0,0,0-1.923.91,337.461,337.461,0,0,0-14.9,30.6,447.848,447.848,0,0,0-134.426,0,309.541,309.541,0,0,0-15.135-30.6,1.89,1.89,0,0,0-1.924-.91A483.689,483.689,0,0,0,116.085,69.137a1.712,1.712,0,0,0-.788.676C39.068,183.651,18.186,294.69,28.43,404.354a2.016,2.016,0,0,0,.765,1.375A487.666,487.666,0,0,0,176.02,479.918a1.9,1.9,0,0,0,2.063-.676A348.2,348.2,0,0,0,208.12,430.4a1.86,1.86,0,0,0-1.019-2.588,321.173,321.173,0,0,1-45.868-21.853,1.885,1.885,0,0,1-.185-3.126c3.082-2.309,6.166-4.711,9.109-7.137a1.819,1.819,0,0,1,1.9-.256c96.229,43.917,200.41,43.917,295.5,0a1.812,1.812,0,0,1,1.924.233c2.944,2.426,6.027,4.851,9.132,7.16a1.884,1.884,0,0,1-.162,3.126,301.407,301.407,0,0,1-45.89,21.83,1.875,1.875,0,0,0-1,2.611,391.055,391.055,0,0,0,30.014,48.815,1.864,1.864,0,0,0,2.063.7A486.048,486.048,0,0,0,610.7,405.729a1.882,1.882,0,0,0,.765-1.352C623.729,277.594,590.933,167.465,524.531,69.836ZM222.491,337.58c-28.972,0-52.844-26.587-52.844-59.239S193.056,219.1,222.491,219.1c29.665,0,53.306,26.82,52.843,59.239C275.334,310.993,251.924,337.58,222.491,337.58Zm195.38,0c-28.971,0-52.843-26.587-52.843-59.239S388.437,219.1,417.871,219.1c29.667,0,53.307,26.82,52.844,59.239C470.715,310.993,447.538,337.58,417.871,337.58Z"/>
        </svg>
    </a>
</nav>    <img src="/assets/images/ollieread.jpg"
         alt="Picture of ollieread"
         class="header__image">

    <div class="header__title">Ollie Read</div>

    <div class="header__nav navbar">
    <a href="/" class="navbar__item ">
        <svg class="navbar__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M272.5 5.7C281.4-1.9 294.6-1.9 303.5 5.7L567.5 229.7C577.6 238.3 578.9 253.4 570.3 263.5C561.7 273.6 546.6 274.9 536.5 266.3L512 245.5V432C512 476.2 476.2 512 432 512H144C99.82 512 64 476.2 64 432V245.5L39.53 266.3C29.42 274.9 14.28 273.6 5.7 263.5C-2.876 253.4-1.634 238.3 8.473 229.7L272.5 5.7zM112 204.8V432C112 449.7 126.3 464 144 464H432C449.7 464 464 449.7 464 432V204.8L288 55.47L112 204.8z"/></svg>
        <svg class="navbar__icon navbar__icon--full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M575.8 255.5c0 18-15 32.1-32 32.1h-32l.7 160.2c.2 35.5-28.5 64.3-64 64.3H128.1c-35.3 0-64-28.7-64-64V287.6H32c-18 0-32-14-32-32.1c0-9 3-17 10-24L266.4 8c7-7 15-8 22-8s15 2 21 7L564.8 231.5c8 7 12 15 11 24z"/></svg>
        Home
    </a>
    <a href="/articles" class="navbar__item ">
        <svg class="navbar__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M456 32h-304C121.1 32 96 57.13 96 88v320c0 13.22-10.77 24-24 24S48 421.2 48 408V112c0-13.25-10.75-24-24-24S0 98.75 0 112v296C0 447.7 32.3 480 72 480h352c48.53 0 88-39.47 88-88v-304C512 57.13 486.9 32 456 32zM464 392c0 22.06-17.94 40-40 40H139.9C142.5 424.5 144 416.4 144 408v-320c0-4.406 3.594-8 8-8h304c4.406 0 8 3.594 8 8V392zM264 272h-64C186.8 272 176 282.8 176 296S186.8 320 200 320h64C277.3 320 288 309.3 288 296S277.3 272 264 272zM408 272h-64C330.8 272 320 282.8 320 296S330.8 320 344 320h64c13.25 0 24-10.75 24-24S421.3 272 408 272zM264 352h-64c-13.25 0-24 10.75-24 24s10.75 24 24 24h64c13.25 0 24-10.75 24-24S277.3 352 264 352zM408 352h-64C330.8 352 320 362.8 320 376s10.75 24 24 24h64c13.25 0 24-10.75 24-24S421.3 352 408 352zM400 112h-192c-17.67 0-32 14.33-32 32v64c0 17.67 14.33 32 32 32h192c17.67 0 32-14.33 32-32v-64C432 126.3 417.7 112 400 112z"/></svg>
        <svg class="navbar__icon navbar__icon--full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M96 96c0-35.3 28.7-64 64-64H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H80c-44.2 0-80-35.8-80-80V128c0-17.7 14.3-32 32-32s32 14.3 32 32V400c0 8.8 7.2 16 16 16s16-7.2 16-16V96zm64 24v80c0 13.3 10.7 24 24 24H424c13.3 0 24-10.7 24-24V120c0-13.3-10.7-24-24-24H184c-13.3 0-24 10.7-24 24zm0 184c0 8.8 7.2 16 16 16h96c8.8 0 16-7.2 16-16s-7.2-16-16-16H176c-8.8 0-16 7.2-16 16zm160 0c0 8.8 7.2 16 16 16h96c8.8 0 16-7.2 16-16s-7.2-16-16-16H336c-8.8 0-16 7.2-16 16zM160 400c0 8.8 7.2 16 16 16h96c8.8 0 16-7.2 16-16s-7.2-16-16-16H176c-8.8 0-16 7.2-16 16zm160 0c0 8.8 7.2 16 16 16h96c8.8 0 16-7.2 16-16s-7.2-16-16-16H336c-8.8 0-16 7.2-16 16z"/></svg>
        Articles
    </a>
    <a href="/archive" class="navbar__item ">
        <svg class="navbar__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M464 32h-416C21.49 32 0 53.49 0 80v64C0 161.6 14.4 176 31.1 176L32 416c0 35.35 28.65 64 64 64h320c35.35 0 64-28.65 64-64V176c17.6 0 32-14.4 32-31.1V80C512 53.49 490.5 32 464 32zM416 432H96c-8.837 0-16-7.163-16-16V176h352V416C432 424.8 424.8 432 416 432zM464 128h-416V80h416V128zM183.1 272h144C341.3 272 352 261.3 352 248C352 234.7 341.3 224 328 224H183.1C170.7 224 160 234.7 160 247.1C160 261.3 170.7 272 183.1 272z"/></svg>
        <svg class="navbar__icon navbar__icon--full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M32 32H480c17.7 0 32 14.3 32 32V96c0 17.7-14.3 32-32 32H32C14.3 128 0 113.7 0 96V64C0 46.3 14.3 32 32 32zm0 128H480V416c0 35.3-28.7 64-64 64H96c-35.3 0-64-28.7-64-64V160zm128 80c0 8.8 7.2 16 16 16H336c8.8 0 16-7.2 16-16s-7.2-16-16-16H176c-8.8 0-16 7.2-16 16z"/></svg>
        Archive
    </a>
    
</div>
</header>

<main class="section content">
    
    
    <div class="panel">
    
    <header class="panel__header">

        <div class="panel__badges">
            <a href="/"
               class="badge badge--green">Category</a>
                            <span class="badge badge--red">Archived</span>
                    </div>

        <h1 class="panel__header-title">Laravel multi-tenancy, avoiding over engineering</h1>

        <time class="panel__header-time">6th August, 2018</time>

    </header>
    <main class="panel__body">
        <div class="notice notice--info">
I'm currently working on a <a href="https://multitenancy.dev" target="_blank">Multitenancy with Laravel</a> course and package that includes the topics covered in this article, and more.
</div>
<ul class="toc">
<li>
<a href="#what-is-multi-tenancy">What is multi-tenancy?</a>
<ul>
<li>
<a href="#what-is-multi-instance">What is multi-instance?</a>
</li>
<li>
<a href="#so-which-do-i-use">So which do I use?</a>
</li>
</ul>
</li>
<li>
<a href="#implementing-multi-tenancy">Implementing multi-tenancy</a>
<ul>
<li>
<a href="#i-found-this-package-for-laravel-that-provides-multi-tenant-support">I found this package for Laravel that provides multi-tenant support</a>
</li>
<li>
<a href="#but-multi-tenancy-is-complicated">But multi-tenancy is complicated</a>
</li>
</ul>
</li>
<li>
<a href="#identifying-the-tenant">Identifying the tenant</a>
<ul>
<li>
<a href="#tenant-manager">Tenant Manager</a>
</li>
<li>
<a href="#identification-middleware">Identification Middleware</a>
</li>
<li>
<a href="#domain-identification">Domain Identification</a>
</li>
<li>
<a href="#subdomain-identification">Subdomain Identification</a>
</li>
<li>
<a href="#bonus-subdomain-or-domain-identification">BONUS: Subdomain OR Domain identification</a>
</li>
<li>
<a href="#path-identification">Path Identification</a>
</li>
</ul>
</li>
<li>
<a href="#how-do-i-generate-tenant-routes">How do I generate tenant routes?</a>
<ul>
<li>
<a href="#domain--subdomain-identification">Domain &amp; Subdomain Identification</a>
</li>
<li>
<a href="#path-identification-1">Path Identification</a>
</li>
</ul>
</li>
<li>
<a href="#handling-tenant-data">Handling tenant data</a>
<ul>
<li>
<a href="#single-database">Single Database</a>
</li>
<li>
<a href="#multiple-databases">Multiple Databases</a>
</li>
</ul>
</li>
<li>
<a href="#what-now">What now?</a>
</li>
</ul>
<p>For those of you that follow my posts, packages or ramblings on Twitter, you'd have noticed that I am a big fan of a multi-tenant systems, specifically those that use subdomains. You may even be aware that I had a package for this very purpose. The package itself has been dormant for a while and has as of yesterday, been abandoned. The primary reason for this is that the layer of abstraction that it added, although simple, was barely worth it.</p>
<p>In this article I'm going to go through the ins and outs of creating a multi-tenant system with Laravel, to show that it really isn't that big a deal.</p>
<h1><a id="what-is-multi-tenancy" href="#what-is-multi-tenancy" class="hidden" aria-hidden="true" title="Permalink"></a>What is multi-tenancy?</h1>
<p>To quote the <a rel="noopener noreferrer" target="_blank" class="link link--external" href="https://en.wikipedia.org/wiki/Multitenancy">multi-tenancy</a> article on Wikipedia;</p>
<blockquote>
<p>The term &quot;software multi-tenancy&quot; refers to a software architecture in which a single instance of software runs on a server and serves multiple tenants. A tenant is a group of users who share a common access with specific privileges to the software instance. With a multi-tenant architecture, a software application is designed to provide every tenant a dedicated share of the instance - including its data, configuration, user management, tenant individual functionality and non-functional properties. Multi-tenancy contrasts with multi-instance architectures, where separate software instances operate on behalf of different tenants.</p>
</blockquote>
<p>To put this in simple terms, a multi-tenanted system is one that appears to be a different system when accessed as a different tenant.</p>
<p>A good example of this would be the Atlassian products with cloud hosting. When I go to <code>myusername.atlassian.net/wiki</code> I see Confluence, except it has my data, my themes, my styles and my information. If you were to go <code>anotheruser.atlassian.net/wiki</code>, you'd see Confluence, but it would all be configured as they have configured it. This particular example uses domain based tenant identification, specifically, subdomains. The first part of the URL tells Confluence that I want to access the content for <code>myusername</code>, and the internal code prevents me from accessing any content or information that isn't linked with me account in some way.</p>
<h3><a id="what-is-multi-instance" href="#what-is-multi-instance" class="hidden" aria-hidden="true" title="Permalink"></a>What is multi-instance?</h3>
<p>Multi-instance systems are similar to multi-tenancy, except that rather than have a single instance of the software serving all of the tenants, there is an instance per tenant. This is far more complicated to achieve, but it opens up a lot of possibilities.</p>
<p>With a multi-instance system, you can have particular features built into a specific tenants instance, allowing for completely custom features. You can do this with multi-tenanted systems, but then your codebase becomes a complete mess, and it's not entirely that easy to do properly.</p>
<h3><a id="so-which-do-i-use" href="#so-which-do-i-use" class="hidden" aria-hidden="true" title="Permalink"></a>So which do I use?</h3>
<p>Both multi-tenant and multi-instance approaches have their shares of pros and cons.</p>
<p><strong>Use Multi-Instance if...</strong>
You want your tenants to have custom bespoke functionality, such as additional features. I'm not talking about tenants having different feature sets, I'm talking about features and functionality that only a particular tenant has, where the code was written specifically for them and doesn't work for other tenants.</p>
<p><strong>Use Multi-Tenant if...</strong>
Essentially, you should use multi-tenant if you don't want the above (that's why I put that one first).</p>
<p>The above are designed to be guidelines, as ultimately the choice is yours (or the stakeholders), and I've been intentionally generic because it'd be possible to list all possible use cases.</p>
<h1><a id="implementing-multi-tenancy" href="#implementing-multi-tenancy" class="hidden" aria-hidden="true" title="Permalink"></a>Implementing multi-tenancy</h1>
<p>Seeing as you're now reading this, I can only assume that you've decided to go for the multi-tenanted approached, so lets look into the different ways we can achieve this.</p>
<h3><a id="i-found-this-package-for-laravel-that-provides-multi-tenant-support" href="#i-found-this-package-for-laravel-that-provides-multi-tenant-support" class="hidden" aria-hidden="true" title="Permalink"></a>I found this package for Laravel that provides multi-tenant support</h3>
<p>Now, I can't speak for every multi-tenant package, but I can safely say that of those that I have encountered, none should be used. Yes, that does include my now abandoned package.</p>
<p>Why you ask? Well let me tell you. Over the years of working with multi-tenant systems I researched a lot, not just the concepts of multi-tenancy, but the code that was available out there. After all, multi-tenancy does seem quite daunting when you get into it. The truth is, it's really not that complicated, and all of the packages I found did something or other that just reeked of bad practice, or was over engineered. Here are a couple of things that I found, that should be avoided.</p>
<p><strong>Nginx/Apache VirtualHost modifications</strong></p>
<p>A few packages out there actually edit your HTTP server configurations as and when a new tenant is created. This is absolutely a no go. Besides the fact that it's completely pointless, as you can achieve the same result by configuring your server correctly (I will cover this a bit later on), having your web server edit configuration files, specifically core configuration files that you need to run this service, is a HUGE issue, with potentially catastrophic results.</p>
<p><strong>Merging responsibility</strong></p>
<p>I understand that not many of you will be quite as fond of 'separation of responsibility' as I am, but it's definitely something to consider. Besides the fact that I genuinely believe that this principal/concept be held to, there are some cases where it just shows shody code. If you're using some sort of URL based tenant identification, Laravels <code>Request</code> object will be at the core of that, and will provide you with the necessary details. It is a trivial task to get what you need from this object and pass that a long down the chain, so there's absolutely no need to pass around the entire instance. If the <code>Request</code> object is being injected into models, scopes, repositories or generally anything outside of the HTTP layer (middleware, controllers, etc), avoid it. What else could be lurking in the code?</p>
<p><strong>Over Engineering</strong></p>
<p>I fell victim to this with my package, though not quite to the extent that I have seen. Later on in this article I'm going to give you some code to show how to implement the different methods of multi-tenancy, and you'll see that they don't involve much code at all. The majority of the packages I have seen over engineer their approaches to the nth level. You may find yourself saying 'But they need be generic, and cover every eventuality'. They do, but again, that can achieved with very little code.</p>
<h3><a id="but-multi-tenancy-is-complicated" href="#but-multi-tenancy-is-complicated" class="hidden" aria-hidden="true" title="Permalink"></a>But multi-tenancy is complicated</h3>
<p>As mentioned above, it's really not. It can seem very daunting when reading up, but then again, any pattern will, just look at repositories.</p>
<p>Generally there are a couple of questions you should answer before writing any code.</p>
<p><strong>How will tenants be identified?</strong></p>
<p><strong>Do my tenants need separate databases?</strong></p>
<p>There are many ways for a tenant to be identified, but for the purpose of this article I'll be covering;</p>
<ul>
<li>URL identification <em>(Identified by part of the URL)</em>
<ul>
<li>Domain</li>
<li>Subdomain</li>
<li>Path</li>
</ul>
</li>
</ul>
<p>I will also be covering both single and multi-database setups.</p>
<p>Now let's take a look at some code.</p>
<h1><a id="identifying-the-tenant" href="#identifying-the-tenant" class="hidden" aria-hidden="true" title="Permalink"></a>Identifying the tenant</h1>
<p>The core part of any multi-tenant system is the tenant, so identifying which tenant the request is for is paramount.</p>
<p>All of the following code will assume the existence of a Tenant model (<code>App\Tenant</code>). Before we get into the specific methods of identifying the tenant, we need to create some base classes that all of the methods will use.</p>
<h3><a id="tenant-manager" href="#tenant-manager" class="hidden" aria-hidden="true" title="Permalink"></a>Tenant Manager</h3>
<p>We need a way to store the current tenant so that it can be accessed where it is needed. We're going to do this by creating a super simple tenant manager, that we will bind to Laravels IoC containerso that we can access the same instance every time we need it.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">namespace</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">App\Services</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Tenant</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">class</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">TenantManager</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #6A737D;">/*</span></div><div class='line'><span style="color: #6A737D;">     * &#64;var null|App\Tenant</span></div><div class='line'><span style="color: #6A737D;">     */</span></div><div class='line'><span style="color: #E1E4E8;">     </span><span style="color: #F97583;">private</span><span style="color: #E1E4E8;"> $tenant;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">setTenant</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">?</span><span style="color: #79B8FF;">Tenant</span><span style="color: #E1E4E8;"> $tenant) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $tenant;</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">getTenant</span><span style="color: #E1E4E8;">()</span><span style="color: #F97583;">:</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">?</span><span style="color: #79B8FF;">Tenant</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">loadTenant</span><span style="color: #E1E4E8;">($identifier)</span><span style="color: #F97583;">:</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">bool</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #6A737D;">// Identify the tenant here</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'><span style="color: #E1E4E8;"> }</span></div></code></pre>
<p>This is a fairly simple class, as we don't really need anything complex. So what do we have?</p>
<ul>
<li>We have a getter (<code>getTenant()</code>) that returns the current tenant or null</li>
<li>We have a setter (<code>setTenant(?Tenant $tenant)</code>) in case we need to manually set (or unset) the tenant</li>
<li>We have a method for loading the tenant (<code>loadTenant($identifier)</code>)</li>
</ul>
<p>The <code>loadTenant($identifier)</code> method is intentionally empty, as that will be the method that we populate for each of our identification methods.</p>
<p>Laravel has a powerful IoC container that lets us bind objects for injection. Typically this is used to bind a concrete for a given interface, but it can also be used to resolve certain instances that aren't just simply instantiated. If you're new to the container, you can read the documentation <a rel="noopener noreferrer" target="_blank" class="link link--external" href="https://laravel.com/docs/5.6/container#binding-basics">here</a>. Here, we're going to leverage the power of this container to;</p>
<ul>
<li>Make sure we receive the same instance of <code>TenantManager</code>
</li>
<li>Avoid having to call <code>TenantManager-&gt;getTenant()</code> everywhere.</li>
</ul>
<p>Either open up <code>AppServiceProvider</code> (<code>app/Providers/AppServiceProvider.php</code>) or create and open a new service provider (You can use <code>php artisan make:provider TenantServiceProvider</code>). Go to the <code>register()</code> method and add the following;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$manager </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">new</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">TenantManager</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">app</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">instance</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">TenantManager</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">, $manager);</span></div><div class='line'><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">app</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">bind</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">Tenant</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">, </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> () </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> ($manager) {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> $manager</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">getTenant</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">});</span></div></code></pre>
<p>Now, when we type hint as <code>TenantManager</code> we will receive the same instance, the one that will be populated with the current tenant. We can also now type hint with <code>Tenant</code> if we want to retrieve the current tenant, without injecting the manager and calling the get tenant method.</p>
<h3><a id="identification-middleware" href="#identification-middleware" class="hidden" aria-hidden="true" title="Permalink"></a>Identification Middleware</h3>
<p>If we're going ahead with URL identification for tenants, we're going to create some middleware to simplify the whole process. Go to your terminal and type <code>php artisan make:middleware IdentifyTenant</code>. Once this is done open up <code>IdentifyTenant</code> (<code>app/Http/Middleware/IdentifyTenant.php</code>) and modify it so it looks like the following;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">namespace</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">App\Http\Middleware</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Closure</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Services\TenantManager</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">class</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">IdentifyTenant</span></div><div class='line'><span style="color: #E1E4E8;">{</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #6A737D;">/**</span></div><div class='line'><span style="color: #6A737D;">    * &#64;var App\Services\TenantManager</span></div><div class='line'><span style="color: #6A737D;">    */</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $tenantManager;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">__construct</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">TenantManager</span><span style="color: #E1E4E8;"> $tenantManager)</span></div><div class='line'><span style="color: #E1E4E8;">    {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $tenantManager;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #6A737D;">/**</span></div><div class='line'><span style="color: #6A737D;">     * Handle an incoming request.</span></div><div class='line'><span style="color: #6A737D;">     *</span></div><div class='line'><span style="color: #6A737D;">     * &#64;param  \Illuminate\Http\Request  $request</span></div><div class='line'><span style="color: #6A737D;">     * &#64;param  \Closure  $next</span></div><div class='line'><span style="color: #6A737D;">     * &#64;return mixed</span></div><div class='line'><span style="color: #6A737D;">     */</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">handle</span><span style="color: #E1E4E8;">($request, </span><span style="color: #79B8FF;">Closure</span><span style="color: #E1E4E8;"> $next)</span></div><div class='line'><span style="color: #E1E4E8;">    {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> $next($request);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>All we did here was add a constructor and a property, so that our <code>TenantManager</code> instance is injected.</p>
<p>Now we just need to wrap our tenant routes in a group with our newly created middleware.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #79B8FF;">Route</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">group</span><span style="color: #E1E4E8;">([</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #9ECBFF;">&#39;middleware&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">=&gt;</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">\App\Http\Middleware\IdentifyTenant</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">,</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #9ECBFF;">&#39;as&#39;</span><span style="color: #E1E4E8;">         </span><span style="color: #F97583;">=&gt;</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;tenant:&#39;</span><span style="color: #E1E4E8;">,</span></div><div class='line'><span style="color: #E1E4E8;">], </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> () {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #6A737D;">// Tenant routes here</span></div><div class='line'><span style="color: #E1E4E8;">});</span></div></code></pre>
<p>I added an <code>as</code> here so that all tenant route names are prefixed with <code>tenant:</code>. Trust me, you'll find this useful.</p>
<p>We now have our tenant manager, and our identification middleware, lets actually identify some tenants.</p>
<h3><a id="domain-identification" href="#domain-identification" class="hidden" aria-hidden="true" title="Permalink"></a>Domain Identification</h3>
<p>If you're familiar with Laravel routes you may be tempted to use the <code>domain</code> attribute for route groups, but we really don't need that here. If you plan to serve a generic section of your system, such as the initial landing and error page, you should wrap those routes in a group using the <code>domain</code> you want them to be accessed from.</p>
<p>First we want to edit our <code>IdentifyTenant::handle</code> method;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">handle</span><span style="color: #E1E4E8;">($request, </span><span style="color: #79B8FF;">Closure</span><span style="color: #E1E4E8;"> $next)</span></div><div class='line'><span style="color: #E1E4E8;">{</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">loadTenant</span><span style="color: #E1E4E8;">($request</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">getHost</span><span style="color: #E1E4E8;">())) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> $next($request);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">throw</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">new</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">NotFoundHttpException</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>Here we are grabbing the domain name <code>$request-&gt;getHost()</code> and passing it to <code>$this-&gt;tenantManager-&gt;loadTenant()</code> which we know will return a bool, then if it succeeds, containing down the middleware chain, or throwing a 404 if no tenant was found. We're doing this all inline inside an if, as there's no need to create unnecessary variables.</p>
<p>Next we're going to edit <code>TenantManager::loadTenant()</code> to perform the identification.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">loadTenant</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">string</span><span style="color: #E1E4E8;"> $identifier)</span><span style="color: #F97583;">:</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">bool</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">    $tenant </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Tenant</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">query</span><span style="color: #E1E4E8;">()</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;domain&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;=&#39;</span><span style="color: #E1E4E8;">, $identifier)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">first</span><span style="color: #E1E4E8;">();</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($tenant) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setTenant</span><span style="color: #E1E4E8;">($tenant);</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">true</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">false</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>Here we're taking the string identifier, and retrieving the first database match for it. I'm assuming that the tenant model has a <code>domain</code> column that contains the domain, and if it does, I'm confident that it has a unique index (If that was too subtle, add a unique index).</p>
<p>There we go, domain based tenant identification done, onto the next.</p>
<h3><a id="subdomain-identification" href="#subdomain-identification" class="hidden" aria-hidden="true" title="Permalink"></a>Subdomain Identification</h3>
<p>Subdomain identification is almost identical to the domain identification, and the rule about not using the <code>domain</code> group attribute, still applies.</p>
<p>First we're going to add an env variable to both <code>.env</code> and <code>.env.example</code>.</p>
<pre><code data-theme="github-dark" data-lang="text" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #e1e4e8;">TENANT_DOMAIN=myawesomeapp.com</span></div></code></pre>
<p>We're going to use this to identify whether the current URL is a tenant subdomain.</p>
<p>Next we want to edit our <code>IdentifyTenant::handle</code> method;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">handle</span><span style="color: #E1E4E8;">($request, </span><span style="color: #79B8FF;">Closure</span><span style="color: #E1E4E8;"> $next)</span></div><div class='line'><span style="color: #E1E4E8;">{</span></div><div class='line'><span style="color: #E1E4E8;">    $host </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $request</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">getHost</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">    $pos </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">strpos</span><span style="color: #E1E4E8;">($host, </span><span style="color: #B392F0;">env</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;TENANT_DOMAIN&#39;</span><span style="color: #E1E4E8;">));</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($pos </span><span style="color: #F97583;">!==</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">false</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">&amp;&amp;</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">loadTenant</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">substr</span><span style="color: #E1E4E8;">($host, </span><span style="color: #79B8FF;">0</span><span style="color: #E1E4E8;">, $pos </span><span style="color: #F97583;">-</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">1</span><span style="color: #E1E4E8;">)) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> $next($request);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">throw</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">new</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">NotFoundHttpException</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>While this is very similar to the domain identification, the difference is the important part. After getting the host we find the position of the <code>TENANT_DOMAIN</code> within it, using <code>strpos()</code>. We then make sure that the result of this isn't <em>EXACTLY</em> false (<code>strpos</code> can return 0, with is equal to false, where as a return of false means it didn't find it), and pass only the first part to our <code>loadTenant()</code> method. We're not passing the whole hostname for many reasons, but mostly because it leaves us open to change domains or use this for other things in the future.</p>
<p>Next we're going to edit <code>TenantManager::loadTenant()</code> to perform the identification.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">loadTenant</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">string</span><span style="color: #E1E4E8;"> $identifier)</span><span style="color: #F97583;">:</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">bool</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">    $tenant </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Tenant</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">query</span><span style="color: #E1E4E8;">()</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;subdomain&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;=&#39;</span><span style="color: #E1E4E8;">, $identifier)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">first</span><span style="color: #E1E4E8;">();</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($tenant) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setTenant</span><span style="color: #E1E4E8;">($tenant);</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">true</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">false</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>As you can see, this is identical to the domain identification, except we are using a different column. Like with the <code>domain</code> column, I'm assuming this is a unique column that contains only the tenant 'slug'.</p>
<p>And that's it for subdomain identification. Marginally more complex than domain identification.</p>
<h3><a id="bonus-subdomain-or-domain-identification" href="#bonus-subdomain-or-domain-identification" class="hidden" aria-hidden="true" title="Permalink"></a>BONUS: Subdomain OR Domain identification</h3>
<p>It's entirely possible that you're providing subdomains for all tenants, but domains for those that pay for a higher package (or those that you like). You can modify both of the above options to allow for this.</p>
<p>We're going to create the env variable as mentioned in subdomain identification, then we're going to merge both pieces of code for the middleware.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">handle</span><span style="color: #E1E4E8;">($request, </span><span style="color: #79B8FF;">Closure</span><span style="color: #E1E4E8;"> $next)</span></div><div class='line'><span style="color: #E1E4E8;">{</span></div><div class='line'><span style="color: #E1E4E8;">    $host </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $request</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">getHost</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">    $pos </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">strpos</span><span style="color: #E1E4E8;">($host, </span><span style="color: #B392F0;">env</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;TENANT_DOMAIN&#39;</span><span style="color: #E1E4E8;">));</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">loadTenant</span><span style="color: #E1E4E8;">($pos </span><span style="color: #F97583;">!==</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">false</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">?</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">substr</span><span style="color: #E1E4E8;">($host, </span><span style="color: #79B8FF;">0</span><span style="color: #E1E4E8;">, $pos </span><span style="color: #F97583;">-</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">1</span><span style="color: #E1E4E8;">) </span><span style="color: #F97583;">:</span><span style="color: #E1E4E8;"> $host, $pos </span><span style="color: #F97583;">!==</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">false</span><span style="color: #E1E4E8;">)) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> $next($request);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">throw</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">new</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">NotFoundHttpException</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>The biggest difference here is that we remove the <code>$pos</code> check from the if, because there may be no subdomain. We replace our <code>loadTenant</code> argument with a ternary if that passes the 'slug' if present, or the whole host. We're also passing in another argument which is a boolean representing whether or not this is a subdomain.</p>
<p>Now we can't make some minor amendments to our <code>TenantManager::loadTenant()</code> method.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">loadTenant</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">string</span><span style="color: #E1E4E8;"> $identifier, </span><span style="color: #F97583;">bool</span><span style="color: #E1E4E8;"> $subdomain)</span><span style="color: #F97583;">:</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">bool</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">    $tenant </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Tenant</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">query</span><span style="color: #E1E4E8;">()</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">subdomain</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">?</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;subdomain&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">:</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;domain&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;=&#39;</span><span style="color: #E1E4E8;">, $identifier)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">first</span><span style="color: #E1E4E8;">();</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($tenant) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setTenant</span><span style="color: #E1E4E8;">($tenant);</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">true</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">false</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>We've add in support for the second argument, as well as another ternary if statement to change the column name we query against.</p>
<p>This is just the basic identification and doesn't include any logic about whether or not a tenant can have domain. Even though that is unfortunately outside the scope of this article, and that I'd never condone the adding of methods to the eloquent model (because it's already bloated), the following is a quick example of how you'd modify your <code>TenantManager::loadTenant()</code> method to achieve this.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($tenant) {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">!</span><span style="color: #E1E4E8;"> $subdomain </span><span style="color: #F97583;">&amp;&amp;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">!</span><span style="color: #E1E4E8;">$tenant</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">canHaveDomain</span><span style="color: #E1E4E8;">()) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">throw</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">new</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">NotFoundHttpException</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setTenant</span><span style="color: #E1E4E8;">($tenant);</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">true</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<h3><a id="path-identification" href="#path-identification" class="hidden" aria-hidden="true" title="Permalink"></a>Path Identification</h3>
<p>Path identification would be identifying the tenant based on a part of the URL path, specifically the first section after the domain. An example of this would be <code>http://myawesome.app/ollieread</code>, where <code>ollieread</code> is the tenant identifier.</p>
<p>For this example, we're actually going to make use of Laravels route parameters, and a little known route instance method that allows us to remove the parameter once it has been processed, so that we don't need to expect it on our controllers. Our tenant route group is going to be slightly different to the one up the top.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #79B8FF;">Route</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">group</span><span style="color: #E1E4E8;">([</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #9ECBFF;">&#39;prefix&#39;</span><span style="color: #E1E4E8;">     </span><span style="color: #F97583;">=&gt;</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;/{tenant}&#39;</span><span style="color: #E1E4E8;">,</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #9ECBFF;">&#39;middleware&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">=&gt;</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">\App\Http\Middleware\IdentifyTenant</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">,</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #9ECBFF;">&#39;as&#39;</span><span style="color: #E1E4E8;">         </span><span style="color: #F97583;">=&gt;</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;tenant:&#39;</span><span style="color: #E1E4E8;">,</span></div><div class='line'><span style="color: #E1E4E8;">], </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> () {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #6A737D;">// Tenant routes here</span></div><div class='line'><span style="color: #E1E4E8;">});</span></div></code></pre>
<p>All we've done is add a prefix using a route variable <code>tenant</code>. Now we can modify our <code>IdentifyTenant::handle()</code> method.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">handle</span><span style="color: #E1E4E8;">($request, </span><span style="color: #79B8FF;">Closure</span><span style="color: #E1E4E8;"> $next)</span></div><div class='line'><span style="color: #E1E4E8;">{</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">loadTenant</span><span style="color: #E1E4E8;">($request</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">route</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">))) {</span></div><div class='line'><span style="color: #E1E4E8;">        $request</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">route</span><span style="color: #E1E4E8;">()</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">forgetParameter</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> $next($request);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">throw</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">new</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">NotFoundHttpException</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>Your instance of Laravels <code>Request</code> object will, if for a matching route, contain an instance of <code>Route</code> that allows us to access the parameters like you see above. Here we're assuming that all of the URLs must be prefixed with <code>/{tenant}</code> so we throw a 404 if no tenant was found. If the tenant was found, we remove the parameter (we don't need it again), and continue down the chain of middleware.</p>
<p>If you plan to support other none tenant specific pages that are also accessible, you'll want to make sure that your tenant route group is defined <em>AFTER</em> all of the others.</p>
<p>Lets modify our <code>TenantManager::loadTenant()</code> method.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">loadTenant</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">string</span><span style="color: #E1E4E8;"> $identifier)</span><span style="color: #F97583;">:</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">bool</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">    $tenant </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Tenant</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">query</span><span style="color: #E1E4E8;">()</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;slug&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;=&#39;</span><span style="color: #E1E4E8;">, $identifier)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">first</span><span style="color: #E1E4E8;">();</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($tenant) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setTenant</span><span style="color: #E1E4E8;">($tenant);</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">true</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">false</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>Like in all of the other examples, I'm assuming that <code>slug</code> is a unique column containing the tenants specific identifier.</p>
<p>There we go, domain, subdomain and path tenant identification, with a bonus subdomain and domain example thrown in.</p>
<h1><a id="how-do-i-generate-tenant-routes" href="#how-do-i-generate-tenant-routes" class="hidden" aria-hidden="true" title="Permalink"></a>How do I generate tenant routes?</h1>
<p>Ahh, this is something that's quite easily overlooked. Since in all of the examples above the URL requires a specific piece of identifying information, your routes just simply won't work properly. In the case of the path identification, it won't even be able to find the routes as there will be a missing parameter.</p>
<p>While I'm going to regret suggesting adding a method to your <code>App\Tenant</code> model, it's the simplest example. So open up your model and add the following method;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">route</span><span style="color: #E1E4E8;">($name, $parameters </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> [], $absolute </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">true</span><span style="color: #E1E4E8;">) {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">app</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;url&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">route</span><span style="color: #E1E4E8;">($name, $parameters, $absolute);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>This is a 1:1 copy of the <code>route()</code> helper method, so that you can do things like <code>$tenant-&gt;route('home.index')</code> or whatever you please. Now, depending on the method of identification that you're using, there are some changes we need to make to this method.</p>
<h3><a id="domain--subdomain-identification" href="#domain--subdomain-identification" class="hidden" aria-hidden="true" title="Permalink"></a>Domain &amp; Subdomain Identification</h3>
<p>For domain and subdomain identification, either supporting both or only one, we're going to do the following;</p>
<p><strong>Domain</strong></p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">route</span><span style="color: #E1E4E8;">($name, $parameters </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> []) {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;https://&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">domain </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">app</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;url&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">route</span><span style="color: #E1E4E8;">($name, $parameters, </span><span style="color: #79B8FF;">false</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p><strong>Subdomain</strong></p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">route</span><span style="color: #E1E4E8;">($name, $parameters </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> []) {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;https://&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">subdomain </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">app</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;url&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">route</span><span style="color: #E1E4E8;">($name, $parameters, </span><span style="color: #79B8FF;">false</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p><strong>Both</strong></p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">route</span><span style="color: #E1E4E8;">($name, $parameters </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> []) {</span></div><div class='line'><span style="color: #E1E4E8;">    $host </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">domain </span><span style="color: #F97583;">??</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">subdomain;</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;https://&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> $host </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">app</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;url&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">route</span><span style="color: #E1E4E8;">($name, $parameters, </span><span style="color: #79B8FF;">false</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>We're removing the third argument from the method and passing <code>false</code> in its place to the real <code>route()</code> method. The reason for this is that when that is <code>true</code>, it will prefix the returned route with the URL, which we're doing manually. I'm using <code>https://</code> because everything should be <code>https://</code> but the choice is yours.</p>
<h3><a id="path-identification-1" href="#path-identification-1" class="hidden" aria-hidden="true" title="Permalink"></a>Path Identification</h3>
<p>Path identification is different, yet still as simple. All we need to do is add the tenant path to the start of the arguments.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">route</span><span style="color: #E1E4E8;">($name, $parameters </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> [], $absolute </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">true</span><span style="color: #E1E4E8;">) {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">app</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;url&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">route</span><span style="color: #E1E4E8;">($name, </span><span style="color: #79B8FF;">array_merge</span><span style="color: #E1E4E8;">([</span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">slug], $parameters), $absolute);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>There we go. Since our little array containing the tenant slug/path is numerically keyed (automatically), it'll be at the start of the resulting array, whether <code>$parameters</code> is numerically keyed or not.</p>
<h1><a id="handling-tenant-data" href="#handling-tenant-data" class="hidden" aria-hidden="true" title="Permalink"></a>Handling tenant data</h1>
<p>By now you've probably encountered two groups of people, polarised by this particular part of multi-tenancy. On one hand you have those that demand that you use a single database for your tenant data (Database as in <code>CREATE DATABASE</code>), while their rivals, demand that you use the multi-database approach.</p>
<p>In reality it's not as clear cut as that. I'm a rather large proponent of the multi-database approach, but that's primarily because it made sense with what I was building. In fact recently, while working on my <a rel="noopener noreferrer" target="_blank" class="link link--external" href="https://worldbuilder.online">WorldBuilder Online</a> project, I came to realise that the requirements had shifted so much, that my multi-database approach was no longer viable and I had to go back to the drawing board on that one.</p>
<p>While you can't entirely avoid having to refactor weeks worth of code, you can help reduce to possibility of doing so, by thinking about it ahead of time, because ultimately, the approach depends entirely on what your system is doing. Generally speaking, I find it boils down to a couple of reasons, so like the choice between multi-tenancy and multi-instance, I've come up with the basic examples below.</p>
<p><strong>Use Multi-Database if...</strong> You require the added security of each tenants data being entirely separate. This will allow you to implement a few extra security measures with ease, such as public key encryption. You should also use multi-database if you're using a NoSQL solution (such as MongoDB) and are creating very complex and independent collections/table.</p>
<p><strong>Use Single-Database if...</strong> Your users are not tenant specific, you have global community features that tie the tenants together, or the data you're storing isn't that complex or in need of higher security.</p>
<p>Whichever way you go, I've written the below to help you implement it inside your Laravel codebase.</p>
<h3><a id="single-database" href="#single-database" class="hidden" aria-hidden="true" title="Permalink"></a>Single Database</h3>
<p>The single database approach is arguable more complex than the multi-database approach. The reason for this is that you have to take a lot of extra steps. As with all other examples, I'll be assuming the existence of <code>App\Tenant</code>.</p>
<p>Any primary model that requires tenant specific data should have a <code>tenant_id</code> foreign key that references <code>id</code> on your <code>tenants</code> table. You can skip the foreign key on any secondary models. By now you're probably wondering what the difference between a primary and a secondary model is? Well wonder no more!</p>
<p><strong>A primary model is...</strong> A model that belongs to a tenant, and cannot exist without its parent tenant. If your tenants can create posts, then your <code>App\Post</code> model should have a <code>tenant_id</code> foreign key.</p>
<p><strong>A secondary model is...</strong> Any model that has ancestors that belong to a tenant. Much like with primary models, this model must only exist with its parent hierarchy. If your users can comment on posts, then you <code>App\Posts\Comment</code> model doesn't need a foreign key, as you can only ever access those comments with a valid instance of <code>App\Post</code>, which will always belong to a tenant.</p>
<p>Outside of this you have your other global models which we shall refer to as your tertiary models. This could be things like <code>App\Category</code> if all of your tenant posts must belong to a generic list of categories. These models don't need a foreign key as they're globally available and not tenant specific.</p>
<p>The simplest way to automate all of this is with the user of traits and Laravel scopes, specifically the global scopes rather than the query based scopes.</p>
<p>So to get started, lets create our global scope. Typically I would create this is <code>app/Scopes</code>, but you can create it wherever you like. We'll call it <code>TenantOwnedScope</code>.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">namespace</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">App\Scopes</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Database\Eloquent\Builder</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Database\Eloquent\Model</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Database\Eloquent\Scope</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Services\TenantManager</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">class</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">TenantOwnedScope</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">implements</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">Scope</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">apply</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">Builder</span><span style="color: #E1E4E8;"> $builder, </span><span style="color: #79B8FF;">Model</span><span style="color: #E1E4E8;"> $model) {</span></div><div class='line'><span style="color: #E1E4E8;">        $manager </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">app</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">TenantManager</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">        $builder</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant_id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;=&#39;</span><span style="color: #E1E4E8;">, $manager</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">getTenant</span><span style="color: #E1E4E8;">()</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">id);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">extend</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">Builder</span><span style="color: #E1E4E8;"> $builder) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">addWithoutTenancy</span><span style="color: #E1E4E8;">($builder);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">addWithoutTenancy</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">Builder</span><span style="color: #E1E4E8;"> $builder) {</span></div><div class='line'><span style="color: #E1E4E8;">        $builder</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">macro</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;withoutTenancy&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> (</span><span style="color: #79B8FF;">Builder</span><span style="color: #E1E4E8;"> $builder) {</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> $builder</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">withoutGlobalScope</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">$this</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">        });</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>Here we have our tenant scope, raring and ready to go. The <code>apply()</code> method will apply the given scope to the query automatically, it accepts an instance of the builder and the current model. We have our <code>extend()</code> method which allows us to add some optional scopes. In this example we add <code>withoutTenancy()</code> added by <code>addWithoutTenancy()</code> so that you can skip the tenant foreign key and retrieve all rows. This is particularly useful for admin areas where you want to see anything and everything.</p>
<p>The reason that we're using a where on the foreign key directly is that bogging everything down with one of Laravels automatically relationship checks is going to be slower, especially if the majority of your models have this scope. The relationship checks (<code>has()</code> and <code>whereHas()</code>) create subqueries which obviously add to a queries overhead.</p>
<p>Now, you can add this scope by overriding a models <code>boot()</code> method, but we don't want to do that, as we're going to do a little bit more magic.</p>
<p>We're going to create ourselves a trait, or a concern as Laravel refers to them. Typically I'd create this in <code>app/Concerns</code>, but you can create it wherever you like. We'll call it <code>OwnedByTenant</code>.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">namespace</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">App\Concerns</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Scopes\TenantOwnedScope</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">trait</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">OwnedByTenant</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">static</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">bootOwnedByTenant</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">static::</span><span style="color: #B392F0;">addGlobalScope</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">new</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">TenantOwnedScope</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">tenant</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">belongsTo</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">Tenant</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;tenant_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>Once we've created this we can add it to any of our primary models like so;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Concerns\OwnedByTenant</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">class</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">PrimaryModel</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">extends</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">Model</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">OwnedByTenant</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>We've done it like this because of a nice little feature of Eloquent. Eloquent will, upon the booting of a model, inspect its traits for a <code>bootTheirName()</code> method (where <code>TheirName</code> is the name of the trait, so that it can boot any additional things, such as scopes. This is how Laravel soft deletes work. This actually automates the adding of our scope, so that you don't have to manually do anything. We've also added a <code>tenant()</code> method with automatically provide the belongs to relationship.</p>
<p>Now, this all works and we can query our primary models and only receive those that belong to the current tenant. But what about inserts? It's all good and well automatically appended where clauses to read, but our writes should have the <code>tenant_id</code> automatically populated.</p>
<p>We achieve this by making use of model events, specifically the <code>creating</code> event. We aren't going to worry about <code>update</code>, as providing that you've written your code properly, it'll be impossible for a model to not currently belong to a tenant.</p>
<p>Go back to your <code>OwnedByTenant</code> trait and edit the <code>bootOwnedByTenant()</code> method to look like the following;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">static</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">bootOwnedByTenant</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">static::</span><span style="color: #B392F0;">addGlobalScope</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">new</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">TenantOwnedScope</span><span style="color: #E1E4E8;">);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">static::</span><span style="color: #B392F0;">creating</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> ($model) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">!</span><span style="color: #E1E4E8;"> $model</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant_id </span><span style="color: #F97583;">&amp;&amp;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">!</span><span style="color: #E1E4E8;"> $model</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">relationLoaded</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">)) {</span></div><div class='line'><span style="color: #E1E4E8;">            $model</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setRelation</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #B392F0;">app</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">TenantManager</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">getTenant</span><span style="color: #E1E4E8;">());</span></div><div class='line'><span style="color: #E1E4E8;">        }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> $model;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>Here we are binding a closure to the creating event. Laravel fires the <code>creating</code> event before performing the actual query, so it's the ideal place for this sort of thing. You may be wondering about my usage of <code>relationLoaded()</code> and <code>setRelation()</code>, but the reason for this is that if we simply did <code>if (! $model-&gt;tenant)</code> Laravel would generate and run a query to eager load that relationship, adding a completely unnecessary query. The usage of <code>setRelation()</code> is because Laravel doesn't entirely like having relationships set using their magic properties. It will also mark the relationship has loaded, preventing Laravel from to retrieve the tenant from the database if the relationship is accessed on this instance.</p>
<p>There we have it, a working single database implementation. The only final point of consideration for this approach is validation and unique indexes. You'll find that as you add more tenants, any unique indexes you have in the database will start shouting if multiple tenants add the same thing. A primary case of this would be if a user has an account with multiple tenants, and your users are tenant specific.</p>
<p>To get around this, add the parent foreign key to your unique indexes. For primary models it'd be <code>$table-&gt;unique(['tenant_id', 'slug'])</code> and for secondary models like <code>App\Posts\Comment</code>, it'd be <code>$table-&gt;unique(['post_id', 'user_id'])</code>.</p>
<p>Now you're going to have an issue with any validation rule that queries the database (<code>unique</code>, <code>exists</code>, etc), unless you define the rules like <code>Rule::unique('posts', 'slug')-&gt;where('tenant_id', app(TenantManager::class)-&gt;getTenant()-&gt;id)</code> which is long winded and takes away the automation that we want to gain from all of this. To get around this, we're going to define a method on our <code>TenantManager</code> class, that essentially does this for us. So open up your <code>TenantManager</code> and add the following methods;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">static</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">unique</span><span style="color: #E1E4E8;">($table, $column </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;NULL&#39;</span><span style="color: #E1E4E8;">)</span></div><div class='line'><span style="color: #E1E4E8;">{</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">new</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Rules\Unique</span><span style="color: #E1E4E8;">($table, $column))</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant_id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">getTenant</span><span style="color: #E1E4E8;">()</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">id);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">static</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">exists</span><span style="color: #E1E4E8;">($table, $column </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;NULL&#39;</span><span style="color: #E1E4E8;">)</span></div><div class='line'><span style="color: #E1E4E8;">{</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">new</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Rules\Exists</span><span style="color: #E1E4E8;">($table, $column))</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant_id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">getTenant</span><span style="color: #E1E4E8;">()</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">id);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>As you can see, these methods are direct copies of <code>Illuminate\Validation\Rule::unique()</code> and <code>Illuminate\Validation\Rule::exists()</code>. I'm only using these two here as they're the most commonly used, but the same method can be applied to any rules. Now when you define your validation rules you can just put <code>TenantManager::unique()</code>, but remember not to use this on secondary or tertiary models.</p>
<p>So now you have an automated single database approach to multi-tenancy, with database based validation support.</p>
<h3><a id="multiple-databases" href="#multiple-databases" class="hidden" aria-hidden="true" title="Permalink"></a>Multiple Databases</h3>
<p>The multi-database approach is very simple, with the exception of migrations and the actual creation of the tenant databases. Unlike the single database approach though, we don't have to bother with scopes or traits, because we know that a tenants database will contain only its data, and that's a beautiful thing.</p>
<p>First things first, we want to tell Laravel about our tenant databases by creating a new connection. For simplicity, I'm going to assume that it's on the same database server.</p>
<p>Open up <code>app/config/database.php</code> and added the following <strong>AFTER</strong> the <code>mysql</code> connection. It's important to keep the original, as that's where our <code>tenants</code> table will exist, and any other global data.</p>
<pre><code data-theme="github-dark" data-lang="text" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #e1e4e8;">&#39;tenant&#39; =&gt; [</span></div><div class='line'><span style="color: #e1e4e8;">    &#39;driver&#39;      =&gt; &#39;mysql&#39;,</span></div><div class='line'><span style="color: #e1e4e8;">    &#39;host&#39;        =&gt; env(&#39;DB_TENANT_HOST&#39;, &#39;127.0.0.1&#39;),</span></div><div class='line'><span style="color: #e1e4e8;">    &#39;port&#39;        =&gt; env(&#39;DB_TENANT_PORT&#39;, &#39;3306&#39;),</span></div><div class='line'><span style="color: #e1e4e8;">    &#39;username&#39;    =&gt; env(&#39;DB_TENANT_USERNAME&#39;, &#39;forge&#39;),</span></div><div class='line'><span style="color: #e1e4e8;">    &#39;password&#39;    =&gt; env(&#39;DB_TENANT_PASSWORD&#39;, &#39;&#39;),</span></div><div class='line'><span style="color: #e1e4e8;">    &#39;unix_socket&#39; =&gt; env(&#39;DB_TENANT_SOCKET&#39;, &#39;&#39;),</span></div><div class='line'><span style="color: #e1e4e8;">    &#39;database&#39; =&gt; &#39;&#39;,</span></div><div class='line'><span style="color: #e1e4e8;">    &#39;charset&#39;     =&gt; &#39;utf8mb4&#39;,</span></div><div class='line'><span style="color: #e1e4e8;">    &#39;collation&#39;   =&gt; &#39;utf8mb4_unicode_ci&#39;,</span></div><div class='line'><span style="color: #e1e4e8;">    &#39;prefix&#39;      =&gt; &#39;&#39;,</span></div><div class='line'><span style="color: #e1e4e8;">    &#39;strict&#39;      =&gt; false,</span></div><div class='line'><span style="color: #e1e4e8;">    &#39;engine&#39;      =&gt; null,</span></div><div class='line'><span style="color: #e1e4e8;">],</span></div></code></pre>
<p>You'll notice that here we're referring to some env variables that don't exist yet, so go ahead and define these in both your <code>.env</code> and <code>.env-example</code> files. Also pay special attention to the fact that we don't have a <code>database</code> entry in our config array.</p>
<p>So how will Laravel know what the database name is? Well, we're going to go back to our provider (<code>AppServiceProvider</code>/<code>TenantServiceProvider</code>) and add the following to bottom of the <code>register()</code> method.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">app[</span><span style="color: #9ECBFF;">&#39;db&#39;</span><span style="color: #E1E4E8;">]</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">extend</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> ($config, $name) </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> ($manager) {</span></div><div class='line'><span style="color: #E1E4E8;">    $tenant </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $manager</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">getTenant</span><span style="color: #E1E4E8;">();</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($tenant) {</span></div><div class='line'><span style="color: #E1E4E8;">        $config[</span><span style="color: #9ECBFF;">&#39;database&#39;</span><span style="color: #E1E4E8;">] </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;tenant_&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> $tenant</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">id;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">app[</span><span style="color: #9ECBFF;">&#39;db.factory&#39;</span><span style="color: #E1E4E8;">]</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">make</span><span style="color: #E1E4E8;">($config, $name);</span></div><div class='line'><span style="color: #E1E4E8;">});</span></div></code></pre>
<p>So what we're doing is extending the default Laravel database resolver, and telling it that to create a new connection for our <code>tenant</code> connection, we should run this closure. This closure will load the current tenant, and set the database name. In this case I'm using <code>tenant_{ID}</code> as the format. We're not throwing an exception if no tenant is set, because there are times when we just want the connection, without a database, which you'll find out about later on.</p>
<p>To have our tenant specific models, both primary and secondary know what to do, we're going open them up and add <code>protected $connection = 'tenant';</code> to the top of the class.</p>
<p>Now we have a working multi-database approach to multi-tenancy. Our models know about the tenant specific database, and Laravel knows how to get the correct database. What we don't have however, is a way of creating the database, and a way of running tenant specific migrations.</p>
<p>Creating migrations the standard way is not going to work, as that's going to end up migrating them on our global database, which we don't want. Create a <code>tenants</code> directory within <code>database/migrations</code>, and append the <code>--path</code> option when creating a migration, like so;</p>
<pre><code data-theme="github-dark" data-lang="text" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #e1e4e8;">php artisan make:migration create_posts_table ---path=database/migrations/tenants`</span></div></code></pre>
<p>By default the migrator is going to ignore this directory, so we don't need to worry about it. But how do we run our tenant migrations? To do so, we're going to need to create a command by running the following in the terminal;</p>
<pre><code data-theme="github-dark" data-lang="text" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #e1e4e8;">php artisan make:command TenantMigrate</span></div></code></pre>
<p>This will create the file <code>app/Console/Commands/TenantMigrate.php</code>, so open it and edit it like so;</p>
<div class="tabs">
<div class="tab__bar">
<div class="tab tab--active" data-target="code-57">Laravel 5.7</div>
<div class="tab" data-target="code-58">Laravel 5.8</div>
</div>
<div class="tab__content tab__content--active" data-name="code-57">
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">namespace</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">App\Console\Commands</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Console\Command</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Services\TenantManager</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Tenant</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">class</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">TenantMigrate</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">extends</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">Command</span><span style="color: #E1E4E8;"> {</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $signature </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;tenants:migrate&#39;</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $description </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;Migrate tenant databases&#39;</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $tenantManager;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $migrator;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">__construct</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">TenantManager</span><span style="color: #E1E4E8;"> $tenantManager) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">parent::</span><span style="color: #B392F0;">__construct</span><span style="color: #E1E4E8;">();</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $tenantManager;</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">migrator </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">app</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;migrator&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">handle</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        $tenants </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Tenant</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">all</span><span style="color: #E1E4E8;">();</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">foreach</span><span style="color: #E1E4E8;"> ($tenants </span><span style="color: #F97583;">as</span><span style="color: #E1E4E8;"> $tenant) {</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setTenant</span><span style="color: #E1E4E8;">($tenant);</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">\DB</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">connection</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">reconnect</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">migrate</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">        }</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">private</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">migrate</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">prepareDatabase</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">run</span><span style="color: #E1E4E8;">(</span><span style="color: #B392F0;">database_path</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;migrations/tenants&#39;</span><span style="color: #E1E4E8;">), []);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">foreach</span><span style="color: #E1E4E8;"> (</span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">getNotes</span><span style="color: #E1E4E8;">() </span><span style="color: #F97583;">as</span><span style="color: #E1E4E8;"> $note) {</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">output</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">writeln</span><span style="color: #E1E4E8;">($note);</span></div><div class='line'><span style="color: #E1E4E8;">        }</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">prepareDatabase</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setConnection</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">!</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">repositoryExists</span><span style="color: #E1E4E8;">()) {</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">call</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;migrate:install&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">        }</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
</div>
<div class="tab__content" data-name="code-58">
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">namespace</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">App\Console\Commands</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Console\Command</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Services\TenantManager</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Tenant</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">class</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">TenantMigrate</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">extends</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">Command</span><span style="color: #E1E4E8;"> {</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $signature </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;tenants:migrate&#39;</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $description </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;Migrate tenant databases&#39;</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $tenantManager;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $migrator;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">__construct</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">TenantManager</span><span style="color: #E1E4E8;"> $tenantManager) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">parent::</span><span style="color: #B392F0;">__construct</span><span style="color: #E1E4E8;">();</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $tenantManager;</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">migrator </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">app</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;migrator&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">handle</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        $tenants </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Tenant</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">all</span><span style="color: #E1E4E8;">();</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">foreach</span><span style="color: #E1E4E8;"> ($tenants </span><span style="color: #F97583;">as</span><span style="color: #E1E4E8;"> $tenant) {</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setTenant</span><span style="color: #E1E4E8;">($tenant);</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">\DB</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">purge</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">migrate</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">        }</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">private</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">migrate</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">prepareDatabase</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">run</span><span style="color: #E1E4E8;">(</span><span style="color: #B392F0;">database_path</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;migrations/tenants&#39;</span><span style="color: #E1E4E8;">), []);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">prepareDatabase</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setConnection</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">!</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">repositoryExists</span><span style="color: #E1E4E8;">()) {</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">call</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;migrate:install&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">        }</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
</div>
</div>
<p>This command is a modified version of the default migration command. The main differences are that we're injecting the tenant manager, and running all tenant migrations for all tenants. The most important bit of this class is the <code>\DB::connection('tenant')-&gt;reconnect()</code> call. When we change to the next tenant in the collection, the old connection is going to still exist, so Laravel won't run our closure, so we're run the migrations on the old tenants database.</p>
<div class="notice notice--info">
In Laravel 5.8 and above, <code>\DB::connection('tenant')-&gt;reconnect()</code> should be replaced with <code>\DB::purge('tenant')</code>
</div>
<p>The <code>prepareDatabase</code> method will create the standard <code>migrations</code> table within the tenant database, meaning that each tenant has a record of the migrations ran.</p>
<p>Now that we have our command, register it by opening up <code>app/Console/Kernel.php</code> and adding <code>App\Console\Commands\TenantMigrate::class</code> to the<code>$commands</code> property.</p>
<p>Now, when you want to run your tenant migrations you can run the following;</p>
<pre><code data-theme="github-dark" data-lang="text" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #e1e4e8;">php artisan tenants:migrate</span></div></code></pre>
<p>You may wondering why we didn't just use the following;</p>
<pre><code data-theme="github-dark" data-lang="text" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #e1e4e8;">php artisan migrate --path=database/migrations/tenants --database=tenant</span></div></code></pre>
<p>The reason, is that that won't cycle through the accounts and update the connection with the tenant database name.</p>
<p>The only thing we have left to do, is create the tenant database in the first place. Typically, I've created myself a job called <code>TenantDatabase</code>, that runs the query. There are lots of ways of doing this, and lots of views and approaches, but the simplest is this.</p>
<p>Run the following command;</p>
<pre><code data-theme="github-dark" data-lang="text" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #e1e4e8;">php artisan make:job TenantDatabase</span></div></code></pre>
<p>This will create the file <code>app/Jobs/TenantDatabase.php</code>, so open it and edit it like so;</p>
<div class="tabs">
<div class="tab__bar">
<div class="tab tab--active" data-target="code-57">Laravel 5.7</div>
<div class="tab" data-target="code-58">Laravel 5.8</div>
</div>
<div class="tab__content tab__content--active" data-name="code-57">
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">namespace</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">App\Jobs</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Services\TenantManager</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Tenant</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Bus\Queueable</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Contracts\Queue\ShouldQueue</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Foundation\Bus\Dispatchable</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Queue\InteractsWithQueue</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">class</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">SetupAccountDatabase</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">implements</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">ShouldQueue</span><span style="color: #E1E4E8;"> {</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Dispatchable</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">InteractsWithQueue</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">Queueable</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $tenant;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $tenantManager;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">__construct</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">Tenant</span><span style="color: #E1E4E8;"> $tenant, </span><span style="color: #79B8FF;">TenantManager</span><span style="color: #E1E4E8;"> $tenantManager) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant        </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $tenant;</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $tenantManager;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">handle</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        $database    </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;tenant_&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">id;</span></div><div class='line'><span style="color: #E1E4E8;">        $connection  </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">\DB</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">connection</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">        $createMysql </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $connection</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">statement</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;</span><span style="color: #F97583;">CREATE</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">DATABASE</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> $database);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($createMysql) {</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setTenant</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant);</span></div><div class='line'><span style="color: #E1E4E8;">            $connection</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">reconnect</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">migrate</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">        } </span><span style="color: #F97583;">else</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">            $connection</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">statement</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;DROP DATABASE &#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> $database);</span></div><div class='line'><span style="color: #E1E4E8;">        }</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">private</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">migrate</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        $migrator </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">app</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;migrator&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">        $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setConnection</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">!</span><span style="color: #E1E4E8;"> $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">repositoryExists</span><span style="color: #E1E4E8;">()) {</span></div><div class='line'><span style="color: #E1E4E8;">            $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">getRepository</span><span style="color: #E1E4E8;">()</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">createRepository</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">        }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">run</span><span style="color: #E1E4E8;">(</span><span style="color: #B392F0;">database_path</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;migrations/tenants&#39;</span><span style="color: #E1E4E8;">), []);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
</div>
<div class="tab__content" data-name="code-58">
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">namespace</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">App\Jobs</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Services\TenantManager</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Tenant</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Bus\Queueable</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Contracts\Queue\ShouldQueue</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Foundation\Bus\Dispatchable</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Queue\InteractsWithQueue</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">class</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">SetupAccountDatabase</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">implements</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">ShouldQueue</span><span style="color: #E1E4E8;"> {</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Dispatchable</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">InteractsWithQueue</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">Queueable</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $tenant;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $tenantManager;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">__construct</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">Tenant</span><span style="color: #E1E4E8;"> $tenant, </span><span style="color: #79B8FF;">TenantManager</span><span style="color: #E1E4E8;"> $tenantManager) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant        </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $tenant;</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $tenantManager;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">handle</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        $database    </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;tenant_&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">id;</span></div><div class='line'><span style="color: #E1E4E8;">        $connection  </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">\DB</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">connection</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">        $createMysql </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $connection</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">statement</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;</span><span style="color: #F97583;">CREATE</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">DATABASE</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> $database);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($createMysql) {</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setTenant</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant);</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">\DB</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">connection</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">purge</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">migrate</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">        } </span><span style="color: #F97583;">else</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">            $connection</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">statement</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;DROP DATABASE &#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> $database);</span></div><div class='line'><span style="color: #E1E4E8;">        }</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">private</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">migrate</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        $migrator </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">app</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;migrator&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">        $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setConnection</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">!</span><span style="color: #E1E4E8;"> $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">repositoryExists</span><span style="color: #E1E4E8;">()) {</span></div><div class='line'><span style="color: #E1E4E8;">            $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">getRepository</span><span style="color: #E1E4E8;">()</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">createRepository</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">        }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">run</span><span style="color: #E1E4E8;">(</span><span style="color: #B392F0;">database_path</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;migrations/tenants&#39;</span><span style="color: #E1E4E8;">), []);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
</div>
</div>
<p>Don't worry, you don't need to have a queue setup if you don't want one, as this will just run inline when called. I created a job because a command shouldn't be called on the web, which is also why we have the <code>migrate()</code> method here. What this class does, is grab the tenant connection, run the statement to create the database, then set the current tenant and reconnect the connection so we're referencing the newly created database, and then run the migration so the database is up to date.</p>
<p>You can run the job by calling <code>App\Jobs\TenantDatabase::dispatch($tenant, app(App\Services\TenantManager::class))</code> wherever you need it to be ran.</p>
<p>So there you go, a fully functioning multi-database approach to multi-tenancy, that handles the database creation as well as tenant database migrations.</p>
<h1><a id="what-now" href="#what-now" class="hidden" aria-hidden="true" title="Permalink"></a>What now?</h1>
<p>Now you build out your system using the methods above. Have a play with the code I've provided and see if you can improve upon it, or tweak it.</p>
<p>I'm considering touching on a few follow ups at some point where I cover basic template customisation per tenant, as well as tenant specific storage.</p>
<p>Let me know in the comments below if there's anything you think I missed, anything you'd like to see, or even to show off something you built by following this.</p>
    </main>
</div>
</main>

    <!-- Fathom - beautiful, simple website analytics -->
    <script src="https://cdn.usefathom.com/script.js" data-site="THPWLTOW" defer></script>
    <!-- / Fathom -->

<script src="/assets/build/js/main.js?id=332d80b6520e8206b9564927e5f9bd73"></script>


</body>
</html>
