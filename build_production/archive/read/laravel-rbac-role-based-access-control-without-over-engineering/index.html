<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <title>Laravel RBAC (role based access control), without over-engineering | ollieread.com</title>

    <link rel="home" href="https://jigsaw-blog-template.tighten.co">
    <link rel="icon" href="/favicon.ico">
    <link href="/blog/feed.atom" type="application/atom+xml" rel="alternate" title="ollieread.com Atom Feed">

    <link rel="stylesheet" href="/assets/build/css/app.css?id=329e22548cfa15d757c9d63c52236e9f">

    
        <!--  Metadata -->
    <meta name="description" content="" />

    <!-- OpenGraph Metadata -->
    <meta name="og:type" property="og:type" content="article" />
    <meta name="og:title" property="og:title" content="Laravel RBAC (role based access control), without over-engineering"/>
    <meta name="og:url" property="og:url" content="https://jigsaw-blog-template.tighten.co/archive/read/laravel-rbac-role-based-access-control-without-over-engineering" />
    <meta name="og:locale" property="og:locale" content="en_GB" />
    <meta name="og:site_name" property="og:site_name" content="ollieread.com"/>
    <meta name="og:image" property="og:image" content="/assets/images/page-thumbnail.png" />

    <!-- Article Metadata -->
    <meta name="article:published_time" property="article:published_time" content="2018-08-16T00:00:00+00:00"/>
    <meta name="article:section" property="article:section" content="tutorials"/>

    <!-- Twitter Metadata -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:creator" content="@ollieread" />
</head>

<body class="antialiased">

<header class="header">

    <nav class="header__links">
    <a href="https://twitter.com/ollieread" target="__blank" class="header__link header__link--twitter">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
    <a href="https://phpc.social/@ollieread" target="__blank" class="header__link header__link--mastodon" rel="me">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg>
    </a>
    <a href="https://github.com/ollieread" target="__blank" class="header__link header__link--github">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
    <a href="https://youtube.com/@olliecodes" target="__blank" class="header__link header__link--youtube">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>
    </a>
    <a href="https://discord.gg/rtQF6jCTk3" target="__blank" class="header__link header__link--discord">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M524.531,69.836a1.5,1.5,0,0,0-.764-.7A485.065,485.065,0,0,0,404.081,32.03a1.816,1.816,0,0,0-1.923.91,337.461,337.461,0,0,0-14.9,30.6,447.848,447.848,0,0,0-134.426,0,309.541,309.541,0,0,0-15.135-30.6,1.89,1.89,0,0,0-1.924-.91A483.689,483.689,0,0,0,116.085,69.137a1.712,1.712,0,0,0-.788.676C39.068,183.651,18.186,294.69,28.43,404.354a2.016,2.016,0,0,0,.765,1.375A487.666,487.666,0,0,0,176.02,479.918a1.9,1.9,0,0,0,2.063-.676A348.2,348.2,0,0,0,208.12,430.4a1.86,1.86,0,0,0-1.019-2.588,321.173,321.173,0,0,1-45.868-21.853,1.885,1.885,0,0,1-.185-3.126c3.082-2.309,6.166-4.711,9.109-7.137a1.819,1.819,0,0,1,1.9-.256c96.229,43.917,200.41,43.917,295.5,0a1.812,1.812,0,0,1,1.924.233c2.944,2.426,6.027,4.851,9.132,7.16a1.884,1.884,0,0,1-.162,3.126,301.407,301.407,0,0,1-45.89,21.83,1.875,1.875,0,0,0-1,2.611,391.055,391.055,0,0,0,30.014,48.815,1.864,1.864,0,0,0,2.063.7A486.048,486.048,0,0,0,610.7,405.729a1.882,1.882,0,0,0,.765-1.352C623.729,277.594,590.933,167.465,524.531,69.836ZM222.491,337.58c-28.972,0-52.844-26.587-52.844-59.239S193.056,219.1,222.491,219.1c29.665,0,53.306,26.82,52.843,59.239C275.334,310.993,251.924,337.58,222.491,337.58Zm195.38,0c-28.971,0-52.843-26.587-52.843-59.239S388.437,219.1,417.871,219.1c29.667,0,53.307,26.82,52.844,59.239C470.715,310.993,447.538,337.58,417.871,337.58Z"/></svg>
    </a>
</nav>    <img src="/assets/images/ollieread.jpg"
         alt="Picture of ollieread"
         class="header__image">

    <div class="header__title">Ollie Read</div>

    <div class="header__nav navbar">
    <a href="/" class="navbar__item ">
        <svg class="navbar__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M272.5 5.7C281.4-1.9 294.6-1.9 303.5 5.7L567.5 229.7C577.6 238.3 578.9 253.4 570.3 263.5C561.7 273.6 546.6 274.9 536.5 266.3L512 245.5V432C512 476.2 476.2 512 432 512H144C99.82 512 64 476.2 64 432V245.5L39.53 266.3C29.42 274.9 14.28 273.6 5.7 263.5C-2.876 253.4-1.634 238.3 8.473 229.7L272.5 5.7zM112 204.8V432C112 449.7 126.3 464 144 464H432C449.7 464 464 449.7 464 432V204.8L288 55.47L112 204.8z"/></svg>
        <svg class="navbar__icon navbar__icon--full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M575.8 255.5c0 18-15 32.1-32 32.1h-32l.7 160.2c.2 35.5-28.5 64.3-64 64.3H128.1c-35.3 0-64-28.7-64-64V287.6H32c-18 0-32-14-32-32.1c0-9 3-17 10-24L266.4 8c7-7 15-8 22-8s15 2 21 7L564.8 231.5c8 7 12 15 11 24z"/></svg>
        Home
    </a>
    <a href="/articles" class="navbar__item ">
        <svg class="navbar__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M456 32h-304C121.1 32 96 57.13 96 88v320c0 13.22-10.77 24-24 24S48 421.2 48 408V112c0-13.25-10.75-24-24-24S0 98.75 0 112v296C0 447.7 32.3 480 72 480h352c48.53 0 88-39.47 88-88v-304C512 57.13 486.9 32 456 32zM464 392c0 22.06-17.94 40-40 40H139.9C142.5 424.5 144 416.4 144 408v-320c0-4.406 3.594-8 8-8h304c4.406 0 8 3.594 8 8V392zM264 272h-64C186.8 272 176 282.8 176 296S186.8 320 200 320h64C277.3 320 288 309.3 288 296S277.3 272 264 272zM408 272h-64C330.8 272 320 282.8 320 296S330.8 320 344 320h64c13.25 0 24-10.75 24-24S421.3 272 408 272zM264 352h-64c-13.25 0-24 10.75-24 24s10.75 24 24 24h64c13.25 0 24-10.75 24-24S277.3 352 264 352zM408 352h-64C330.8 352 320 362.8 320 376s10.75 24 24 24h64c13.25 0 24-10.75 24-24S421.3 352 408 352zM400 112h-192c-17.67 0-32 14.33-32 32v64c0 17.67 14.33 32 32 32h192c17.67 0 32-14.33 32-32v-64C432 126.3 417.7 112 400 112z"/></svg>
        <svg class="navbar__icon navbar__icon--full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M96 96c0-35.3 28.7-64 64-64H448c35.3 0 64 28.7 64 64V416c0 35.3-28.7 64-64 64H80c-44.2 0-80-35.8-80-80V128c0-17.7 14.3-32 32-32s32 14.3 32 32V400c0 8.8 7.2 16 16 16s16-7.2 16-16V96zm64 24v80c0 13.3 10.7 24 24 24H424c13.3 0 24-10.7 24-24V120c0-13.3-10.7-24-24-24H184c-13.3 0-24 10.7-24 24zm0 184c0 8.8 7.2 16 16 16h96c8.8 0 16-7.2 16-16s-7.2-16-16-16H176c-8.8 0-16 7.2-16 16zm160 0c0 8.8 7.2 16 16 16h96c8.8 0 16-7.2 16-16s-7.2-16-16-16H336c-8.8 0-16 7.2-16 16zM160 400c0 8.8 7.2 16 16 16h96c8.8 0 16-7.2 16-16s-7.2-16-16-16H176c-8.8 0-16 7.2-16 16zm160 0c0 8.8 7.2 16 16 16h96c8.8 0 16-7.2 16-16s-7.2-16-16-16H336c-8.8 0-16 7.2-16 16z"/></svg>
        Articles
    </a>
    <a href="/archive" class="navbar__item ">
        <svg class="navbar__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M464 32h-416C21.49 32 0 53.49 0 80v64C0 161.6 14.4 176 31.1 176L32 416c0 35.35 28.65 64 64 64h320c35.35 0 64-28.65 64-64V176c17.6 0 32-14.4 32-31.1V80C512 53.49 490.5 32 464 32zM416 432H96c-8.837 0-16-7.163-16-16V176h352V416C432 424.8 424.8 432 416 432zM464 128h-416V80h416V128zM183.1 272h144C341.3 272 352 261.3 352 248C352 234.7 341.3 224 328 224H183.1C170.7 224 160 234.7 160 247.1C160 261.3 170.7 272 183.1 272z"/></svg>
        <svg class="navbar__icon navbar__icon--full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. --><path d="M32 32H480c17.7 0 32 14.3 32 32V96c0 17.7-14.3 32-32 32H32C14.3 128 0 113.7 0 96V64C0 46.3 14.3 32 32 32zm0 128H480V416c0 35.3-28.7 64-64 64H96c-35.3 0-64-28.7-64-64V160zm128 80c0 8.8 7.2 16 16 16H336c8.8 0 16-7.2 16-16s-7.2-16-16-16H176c-8.8 0-16 7.2-16 16z"/></svg>
        Archive
    </a>
    
</div>
</header>

<main class="section content">
    
    
    <div class="panel">
    
    <header class="panel__header">

        <div class="panel__badges">
            <a href="/"
               class="badge badge--green">Category</a>
                            <span class="badge badge--red">Archived</span>
                    </div>

        <h1 class="panel__header-title">Laravel RBAC (role based access control), without over-engineering</h1>

        <time class="panel__header-time">16th August, 2018</time>

    </header>
    <main class="panel__body">
        <p>Access control is everywhere you look. GitHub, BitBucket, Slack, Atlassian, DigitalOcean, and many many more employ the usage of access control to...well...control access.</p>
<p>Does your project have need of multiple levels of admin, or does it support teams whereby users can invite other users to share access/contribute? Perhaps you have a discussion board/forum and you want certain users to administer, while others only moderate or contribute. If that's the case, then you'll want to implement some type of access control. The most common terms used to refer to this kind of functionality, is that of roles &amp; permissions or RBAC.</p>
<p>Much like anything else, everyone and their dog has a Laravel package out there providing roles &amp; permissions, and they're over-engineered or over-complicated. I know this is the second article I've written in as many weeks regarding the over-engineering of features, but it really is an issue. If something is over-engineered or over-complicated it's quite difficult to figure out what exactly is happening, and more often than not, you're not going to have the time to dedicate to figuring out what the developers are doing, so you just end up using the package blindly.</p>
<p>Do you really want to trust code that you don't know, to control something as sensitive as the access that users have to your content? It's a rhetorical question, the answer is no. If you answered yes, you're wrong.</p>
<p>In this article I'm going to run down how to implement a relatively simple, yet flexible and powerful RBAC with Laravel, as well as explaining it as we go.</p>
<h1><a id="what-exactly-is-an-rbac" href="#what-exactly-is-an-rbac" class="hidden" aria-hidden="true" title="Permalink"></a>What exactly is an RBAC?</h1>
<p>RBAC stands for role based access control and is more than likely what you actually think of when you hear the term ACL. I myself have fallen foul of this as I wrote an article back in 2016 about writing a simplified ACL with Laravel. What I wrote, was an RBAC, and that article is essentially the ancestor of this one.</p>
<p>To quote the <a rel="noopener noreferrer" target="_blank" class="link link--external" href="https://en.wikipedia.org/wiki/Role-based_access_control">RBAC</a> Wikipedia entry;</p>
<blockquote>
<p>Role-based-access-control (RBAC) is a policy neutral access control mechanism defined around roles and privileges. The components of RBAC such as role-permissions, user-role and role-role relationships make it simple to perform user assignments.</p>
</blockquote>
<p>As you'll see from the above, this falls more inline with our role and permission setup. The idea is that a user, or a given authenticated entity is assigned one or more roles. Each of those roles will have a set of permissions which directly correlate to actions within the system, or at least, represent them. It's rare that we care whether or not a user has a particular role as they're essentially just a way to group permissions.</p>
<h3><a id="but-what-about-acl" href="#but-what-about-acl" class="hidden" aria-hidden="true" title="Permalink"></a>But what about ACL?</h3>
<p>The terms ACL and RBAC are commonly mixed up, and while the definitions are theoretically interchangeable, they're technically quite different. The Wikipedia entry for <a rel="noopener noreferrer" target="_blank" class="link link--external" href="https://en.wikipedia.org/wiki/Access_control_list">ACL</a> says;</p>
<blockquote>
<p>An access control list (ACL), with respect to a computer file system, is a list of permissions attached to an object. An ACL specifies which users or system processes are granted access to objects, as well as what operations are allowed on given objects.</p>
</blockquote>
<p>With an ACL you're controlling access to individual objects, or in our case, rows. You could arguably consider Laravels Policies to be a form of ACL, as you check per object/model instance, rather than as a whole on the resource. It's a very loose comparison as Policies are open to interpretation and implementation.</p>
<h1><a id="creating-an-rbac" href="#creating-an-rbac" class="hidden" aria-hidden="true" title="Permalink"></a>Creating an RBAC</h1>
<p>Creating role based access control within Laravel is actually quite a simple matter. Much like multi-tenancy, it's one of those things that appears far more complicated than it actually is.</p>
<p>Here's what we know of RBACs so far;</p>
<ul>
<li>It has users
<ul>
<li>Users have 1 or more roles</li>
</ul>
</li>
<li>It has roles
<ul>
<li>Roles have permissions</li>
</ul>
</li>
<li>It has permissions</li>
</ul>
<p>This particular list translates almost directly to Eloquent relationships, so lets start there. We're going to need three models to achieve this, but I'm assuming that you already have a <code>User</code> model or some other authenticated model, whether it's an admin or what.</p>
<h3><a id="creating-our-role-model" href="#creating-our-role-model" class="hidden" aria-hidden="true" title="Permalink"></a>Creating our Role model</h3>
<p>Our first model to create is a <code>Role</code> model, aha role model!</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">namespace</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">App\Models</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Database\Eloquent\Model</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">class</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">Role</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">extends</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">Model</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $table </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;roles&#39;</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $fillable </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> [</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #9ECBFF;">&#39;name&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;ident&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;description&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;active&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;level&#39;</span><span style="color: #E1E4E8;">,</span></div><div class='line'><span style="color: #E1E4E8;">    ];</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $casts </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> [</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #9ECBFF;">&#39;active&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">=&gt;</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;bool&#39;</span><span style="color: #E1E4E8;">,</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #9ECBFF;">&#39;level&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">=&gt;</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;int&#39;</span><span style="color: #E1E4E8;">,</span></div><div class='line'><span style="color: #E1E4E8;">    ];</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>It's a straight forward model, though you may be curious about 3 of the fields I've added here. The <code>ident</code> field is essentially a sluggified version of the <code>name</code> and exists solely in case we do care what role a user has. The <code>active</code> field is one I add to almost everything these days, as this allows me to enable or disable a role, and trust me, there are plenty of reasons you'd do this.</p>
<p>The last field, <code>level</code>, is there to define a loose hierarchy of roles. For example, you may have three different roles with permission to edit users, and without this level control, a user with a lower role could swap out their roles, or even edit users above them in the hierarchy. For the purpose of this article, I'm going to consider <code>0</code> to be the highest, because ascending order is simplest.</p>
<h3><a id="creating-our-permission-model" href="#creating-our-permission-model" class="hidden" aria-hidden="true" title="Permalink"></a>Creating our Permission model</h3>
<p>Now that we've got our roles, we need to add permissions.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">namespace</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">App\Models</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Database\Eloquent\Model</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">class</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">Permission</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">extends</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">Model</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $table </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;permissions&#39;</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $fillable </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> [</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #9ECBFF;">&#39;name&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;ident&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;description&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;active&#39;</span><span style="color: #E1E4E8;">,</span></div><div class='line'><span style="color: #E1E4E8;">    ];</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $casts </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> [</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #9ECBFF;">&#39;active&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">=&gt;</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;bool&#39;</span><span style="color: #E1E4E8;">,</span></div><div class='line'><span style="color: #E1E4E8;">    ];</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>Again, relatively straight forward. It's almost identical to the <code>Role</code> model, save for the <code>level</code> field. I've kept the <code>active</code> field because disabling a permission is a brilliant way of quickly disabling features. The feature technically isn't disabled, but no one can get access to it.</p>
<p>I'd like to talk about the <code>ident</code> field for a minute. So, I like to name my permissions in the same way that I name routes, and those follow the pattern <code>resource[.child-resource].action</code>. In fact, I have a direct correlation between 90% of my permissions and the route names. The reason I use the dot notation, is that if I were to add the permission <code>blog.post.index</code>, my system would add the following extra permissions;</p>
<ul>
<li>
<code>blog.*</code>
</li>
<li>
<code>blog.post.*</code>
</li>
</ul>
<p>This would allow me to give a particular role blanket permissions for the <code>blog</code> namespace or the <code>blog.post</code> namespace. I also make sure to add a <code>*</code> permission which is essentially a wildcard that's acceptable by any and all. Normally this is assigned to an <code>admin.super</code> role that only I have access to.</p>
<p>On top of wildcard permissions, I'll also often create other permissions that don't strictly follow the pattern. A good example of this would be <code>user.email</code>, whereby only users/admins with this permission can see the email address of a user. With some CMS systems I've built, I've created a <code>Page</code> model that has a <code>structure_edit</code> and a <code>has_content</code> flag, with the former controlling whether or not the slug can be edited, and the latter being whether or not to display the WYSIWYG editor. Now, I don't want to go around editing the database to change these, so I hide the form checkboxes in an if statement that checks for <code>page.admin</code>, allowing me to assign an extra layer of granular permissions on top of <code>page.edit</code>.</p>
<p>Now that we have our models, we're going to need to define the relationships between them.</p>
<h1><a id="defining-the-relationships" href="#defining-the-relationships" class="hidden" aria-hidden="true" title="Permalink"></a>Defining the relationships</h1>
<p>Your <code>Role</code> model is going to need to know that it has permissions. Add the following method to your <code>Role</code> model.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">permissions</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">belongsToMany</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">App\Models\Permission</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;role_permissions&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;role_id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;permission_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>To define the inverse, add the following to your <code>Permission</code> model.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">roles</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">belongsToMany</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">App\Models\Role</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;role_permissions&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;permission_id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;role_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>This relationship is called a <a rel="noopener noreferrer" target="_blank" class="link link--external" href="https://laravel.com/docs/5.6/eloquent-relationships#many-to-many">many to many</a> relationship, and utilises something called a pivot table. In this case, our pivot table is  called <code>role_permission</code> and will simply contain <code>permission_id</code> and <code>role_id</code> columns.</p>
<p>Now you need to go to your user model, or whatever your authenticated entity is, and define the relationships. Now, I always go for users having more than 1 role, but you don't have to.</p>
<p>To allow for multiple roles, add the following to your model;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">roles</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">belongsToMany</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">App\Models\Role</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;user_roles&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;user_id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;role_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>Then on your <code>Role</code> model add the inverse;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">users</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">belongsToMany</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">App\Models\User</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;user_roles&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;role_id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;user_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>If you only want users to have 1 role, you can add the following instead to your user model;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">role</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">belongsTo</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">App\Models\Role</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;role_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>Then the inverse on your <code>Role</code> model would be;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">users</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">hasMany</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">App\Models\User</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;role_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>Unlike all of the other relationships, this is a <a rel="noopener noreferrer" target="_blank" class="link link--external" href="https://laravel.com/docs/5.6/eloquent-relationships#one-to-many">one to many</a> relationship. Your user model will need to contain the foreign key <code>role_id</code> to define which role they belong to. Honestly, I don't like this method as it feels too limiting. There's realistically more complexity in only allowing one role than there is allowing for multiple.</p>
<h3><a id="bonus-direct-user-permissions" href="#bonus-direct-user-permissions" class="hidden" aria-hidden="true" title="Permalink"></a>BONUS: Direct user permissions</h3>
<p>It's entirely plausible to want to assign a particular permission to a user, without creating a separate role or giving them all of the permissions that'd come with being assigned to a role. If you wish to do this, you can have a direct relationship between a user and additional permissions. To do so, add the following to your user model;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">permissions</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">belongsToMany</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">App\Models\Permission</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;user_permissions&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;user_id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;permission_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>Then add the inverse to your <code>Permission</code> model;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">users</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">belongsToMany</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">App\Models\User</span><span style="color: #F97583;">::class</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;user_permissions&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;permission_id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;user_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<h1><a id="creating-our-migrations" href="#creating-our-migrations" class="hidden" aria-hidden="true" title="Permalink"></a>Creating our migrations</h1>
<p>I'm also assuming here that you're familiar with migrations, so I'll only be giving you the blueprint configuration for the inside of the closure.</p>
<h3><a id="creating-our-role-migration" href="#creating-our-role-migration" class="hidden" aria-hidden="true" title="Permalink"></a>Creating our Role migration</h3>
<p>To create your role migration, run the following command;</p>
<pre><code data-theme="github-dark" data-lang="bash" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #B392F0;">php</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">artisan</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">make:migration</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">create_roles_table</span></div></code></pre>
<p>Open up the <code>database/migrations/YYYY_MM_DD_HHMMSS_create_roles_table.php</code> file and add the following to the closure inside the <code>up()</code> method.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">increments</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">string</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;name&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">string</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;ident&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">unique</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">text</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;description&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">boolean</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;active&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">default</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">0</span><span style="color: #E1E4E8;">); </span><span style="color: #6A737D;">// Default is an int because Laravel will create a TINYINT column</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">integer</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;level&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">default</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">99</span><span style="color: #E1E4E8;">); </span><span style="color: #6A737D;">// Default can be whatever you want really</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">timestamps</span><span style="color: #E1E4E8;">();</span></div></code></pre>
<h3><a id="creating-our-permission-migration" href="#creating-our-permission-migration" class="hidden" aria-hidden="true" title="Permalink"></a>Creating our Permission migration</h3>
<p>Much like the role migration, run the following command in your terminal;</p>
<pre><code data-theme="github-dark" data-lang="bash" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #B392F0;">php</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">artisan</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">make:migration</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">create_permissions_table</span></div></code></pre>
<p>Now open up the <code>database/migrations/YYYY_MM_DD_HHMMSS_create_permissions_table.php</code> file and add the following to the closure inside the <code>up()</code> method.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">increments</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">string</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;name&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">string</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;ident&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">unique</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">text</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;description&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">boolean</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;active&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">default</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">0</span><span style="color: #E1E4E8;">); </span><span style="color: #6A737D;">// Default is an int because Laravel will create a TINYINT column</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">timestamps</span><span style="color: #E1E4E8;">();</span></div></code></pre>
<h3><a id="pivot-table-migrations" href="#pivot-table-migrations" class="hidden" aria-hidden="true" title="Permalink"></a>Pivot table migrations</h3>
<p>Now that we have our migrations for both the <code>roles</code> and the <code>permissions</code> table we need to add a migration for the pivot tables, <code>role_permission</code> and <code>user_roles</code>.</p>
<p>Run the following command;</p>
<pre><code data-theme="github-dark" data-lang="bash" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #B392F0;">php</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">artisan</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">make:migration</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">create_role_permissions_table</span></div></code></pre>
<p>Now open up the <code>database/migrations/YYYY_MM_DD_HHMMSS_create_role_permissions_table.php</code> file and add the following to the closure inside the <code>up()</code> method.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">unsignedInteger</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;role_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">unsignedInteger</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;permission_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">foreign</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;role_id&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">references</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;id&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">on</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;roles&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">onDelete</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;cascade&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">foreign</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;permission_id&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">references</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;id&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">on</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;permissions&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">onDelete</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;cascade&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">unique</span><span style="color: #E1E4E8;">([</span><span style="color: #9ECBFF;">&#39;role_id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;permission_id&#39;</span><span style="color: #E1E4E8;">]);</span></div></code></pre>
<p>We're adding foreign keys here as we only want valid entries. We're also adding a multi-column unique key so that we don't end up adding permissions to roles more than once.</p>
<p>If you opted to have your users capable of holding more than one role, you can repeat the above like so.</p>
<p>Run the following command;</p>
<pre><code data-theme="github-dark" data-lang="bash" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #B392F0;">php</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">artisan</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">make:migration</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">create_user_roles_table</span></div></code></pre>
<p>Now open up the <code>database/migrations/YYYY_MM_DD_HHMMSS_create_user_roles_table.php</code> file and add the following to the closure inside the <code>up()</code> method.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">unsignedInteger</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;role_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">unsignedInteger</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;user_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">foreign</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;role_id&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">references</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;id&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">on</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;roles&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">onDelete</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;cascade&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">foreign</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;user_id&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">references</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;id&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">on</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;users&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">onDelete</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;cascade&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">unique</span><span style="color: #E1E4E8;">([</span><span style="color: #9ECBFF;">&#39;role_id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;user_id&#39;</span><span style="color: #E1E4E8;">]);</span></div></code></pre>
<p>If instead you want your users to have only one role, you'll need to generate a migration that adds the following;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">unsignedInteger</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;role_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">foreign</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;role_id&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">references</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;id&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">on</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;roles&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">onDelete</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;cascade&#39;</span><span style="color: #E1E4E8;">);</span></div></code></pre>
<p>To run these migrations simply run the <code>php artisan migrate</code> command.</p>
<h3><a id="bonus-direct-user-permission-migration" href="#bonus-direct-user-permission-migration" class="hidden" aria-hidden="true" title="Permalink"></a>BONUS: Direct user permission migration</h3>
<p>If you've chosen to allow for users to have specific permissions assigned to them, you're going to need to create that pivot table too, much like we did for <code>user_roles</code>.</p>
<p>Run the following command;</p>
<pre><code data-theme="github-dark" data-lang="bash" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #B392F0;">php</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">artisan</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">make:migration</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">create_user_permissions_table</span></div></code></pre>
<p>Now open up the <code>database/migrations/YYYY_MM_DD_HHMMSS_create_user_permissions_table.php</code> file and add the following to the closure inside the <code>up()</code> method.</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">unsignedInteger</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;user_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">unsignedInteger</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;permission_id&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">foreign</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;user_id&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">references</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;id&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">on</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;users&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">onDelete</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;cascade&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">foreign</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;permission_id&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">references</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;id&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">on</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;permissions&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">onDelete</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;cascade&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$table</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">unique</span><span style="color: #E1E4E8;">([</span><span style="color: #9ECBFF;">&#39;user_id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;permission_id&#39;</span><span style="color: #E1E4E8;">]);</span></div></code></pre>
<p>Again we're adding foreign key relationships, and a multi-column unique key so that we don't assign the same permission to a user multiple times.</p>
<h1><a id="implementing-our-rbac" href="#implementing-our-rbac" class="hidden" aria-hidden="true" title="Permalink"></a>Implementing our RBAC</h1>
<p>Laravel ships with some <a rel="noopener noreferrer" target="_blank" class="link link--external" href="https://laravel.com/docs/5.6/authorization">authorisation</a> functionality, including the policies that I mentioned above. While we don't care about policies, we do care about the <a rel="noopener noreferrer" target="_blank" class="link link--external" href="https://laravel.com/docs/5.6/authorization#gates">gate</a>.</p>
<p>Laravels Gates allow us to define the resolution logic for checking that a user has a given 'gate', which in this case is synonymous for permission. Now, it's highly likely that you're going to be checking more than one permission per request, and while you could pull all permissions down, define gates, and then query for each permission, that's not really ideal. Normally I would actually implement my own version of the <code>Gate</code> contract, because it doesn't work for the way that I handle permissions. That's somewhat outside the scope of this article, and to keep things simple I'm going to leave the default one in place.</p>
<h3><a id="registering-our-permissions" href="#registering-our-permissions" class="hidden" aria-hidden="true" title="Permalink"></a>Registering our Permissions</h3>
<p>Because of the way the default <code>Gate</code> works, you need to register all of your permissions for it know whether or not a user has them. You may think that we can get away with just registering the specific permissions that a user has, but that isn't the case. Because of the wildcard permissions that we add, the gate needs to know of them all. We'll never actually check for the wildcard permissions directly, but we will definitely use permissions that are covered by them.</p>
<p>Here you can either use <code>AppServiceProvider</code> or create your own provider with <code>make:provider</code>. Once you've opened your provider of choice you're going to want to put the following in the boot method;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$permissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Permission</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">pluck</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;ident&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">$permissions</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">each</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">string</span><span style="color: #E1E4E8;"> $ident) {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #79B8FF;">Gate</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">define</span><span style="color: #E1E4E8;">($ident, </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> (</span><span style="color: #79B8FF;">User</span><span style="color: #E1E4E8;"> $user) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #6A737D;">// todo: Add permission checking</span></div><div class='line'><span style="color: #E1E4E8;">    });</span></div></code></pre>
<p>We put this in the boot method because we want to make sure all the other services are registered, services such as the DB and the the auth gates. If you wanted to avoid having to perform a query on every request, you could take this a bit further and cache the results. If you wanted to do this, you could do the following;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$cacheKey </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;permissions&#39;</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">$permissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Cache</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">get</span><span style="color: #E1E4E8;">($cacheKey);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">!</span><span style="color: #E1E4E8;"> $permissions) {</span></div><div class='line'><span style="color: #E1E4E8;">    $permissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Permission</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">pluck</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;ident&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #79B8FF;">Cache</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">put</span><span style="color: #E1E4E8;">($cacheKey, $permissions</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">toArray</span><span style="color: #E1E4E8;">());</span></div><div class='line'><span style="color: #E1E4E8;">} </span><span style="color: #F97583;">else</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">    $permissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">collect</span><span style="color: #E1E4E8;">($permissions);</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">$permissions</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">each</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">string</span><span style="color: #E1E4E8;"> $ident) {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #79B8FF;">Gate</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">define</span><span style="color: #E1E4E8;">($ident, </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> (</span><span style="color: #79B8FF;">User</span><span style="color: #E1E4E8;"> $user) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #6A737D;">// todo: Add permission checking</span></div><div class='line'><span style="color: #E1E4E8;">    });</span></div></code></pre>
<p>Here we are checking for the permissions in the cache before hitting the database, and if there are no permissions in the cache, we grab the results from the database and then cache those for future use. Since your actual permissions are unlikely to change frequently it's okay to cache the results. However, if you add a new permission or edit the ident of an existing permission, you'll need to invalidate this cache with <code>Cache::forget('permissions')</code>.</p>
<p>(I'm using <code>User</code> here, but that should be whatever your model is)</p>
<p>You'll also notice that we've left a todo in there. That's because there is something other stuff we need to do before we can actually check a users permissions.</p>
<h3><a id="alternative-permissions" href="#alternative-permissions" class="hidden" aria-hidden="true" title="Permalink"></a>Alternative Permissions</h3>
<p>Alternative permissions are the wildcard permissions we've spoken about previously. If you're checking whether or not a user can <code>blog.post.create</code>, that should also accept the following;</p>
<ul>
<li>
<code>*</code>
</li>
<li>
<code>blog.*</code>
</li>
<li>
<code>blog.post.*</code>
</li>
</ul>
<p>To actually get the alternative permissions we need to build this list up. There are several ways we can go about this, and none of them are pretty. I'm open to suggestions for this, but this is generally how I'd go about it;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$altPermissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> [</span><span style="color: #9ECBFF;">&#39;*&#39;</span><span style="color: #E1E4E8;">, $permission];</span></div><div class='line'><span style="color: #E1E4E8;">$permParts </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">explode</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;.&#39;</span><span style="color: #E1E4E8;">, $permission);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($permParts </span><span style="color: #F97583;">&amp;&amp;</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">count</span><span style="color: #E1E4E8;">($permParts) </span><span style="color: #F97583;">&gt;</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">1</span><span style="color: #E1E4E8;">) {</span></div><div class='line'><span style="color: #E1E4E8;">    $currentPermission </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;&#39;</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">for</span><span style="color: #E1E4E8;"> ($i </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">0</span><span style="color: #E1E4E8;">; $i </span><span style="color: #F97583;">&lt;</span><span style="color: #E1E4E8;"> (</span><span style="color: #79B8FF;">count</span><span style="color: #E1E4E8;">($permParts) </span><span style="color: #F97583;">-</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">1</span><span style="color: #E1E4E8;">); $i</span><span style="color: #F97583;">++</span><span style="color: #E1E4E8;">) {</span></div><div class='line'><span style="color: #E1E4E8;">        $currentPermission </span><span style="color: #F97583;">.=</span><span style="color: #E1E4E8;"> $permParts[$i] </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;.&#39;</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">        $altPermissions[] </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $currentPermission </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;*&#39;</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> $altPermissions;</span></div></code></pre>
<p>Let me run through what this is doing.</p>
<p>I'm assuming that the value of <code>$permission</code> is a string, and contains the permission ident we want to get the alternative permissions for. The first thing we do is start building up an array of permissions, and since we can be certain that <code>*</code> is accepted here, and the actual permission, we can add those to the array without worrying. Next we're going to <a rel="noopener noreferrer" target="_blank" class="link link--external" href="http://php.net/explode">explode</a> the permission by the <code>.</code> character, which essentially splits it by that character and gives us an array containing the parts. If the <code>.</code> character is not found, we'll get an array containing the whole permission, which we don't care about as we already have the full permission.</p>
<p>Next we loop through all of the parts using a for loop. I'm using a for loop here because we want to run through all parts but the last. We build up a <code>$currentPermission</code> by just appending the current part, plus <code>.</code> to the end, before added that to our array with a <code>*</code> on the end. If I were to now call <code>$permissions = altPermissions('blog.post.create')</code> I'd get back an array with the following;</p>
<ul>
<li>
<code>*</code>
</li>
<li>
<code>blog.post.create</code>
</li>
<li>
<code>blog.post.*</code>
</li>
<li>
<code>blog.*</code>
</li>
</ul>
<p>In my example there I have the helper function <code>altPermissions(string $permission): array</code> so I'll be going with that for the rest of my examples. You should replace this with whatever you're using. You could put this as a method on the <code>Permission</code> model, or have it as a helper function somewhere, perhaps even put in your service provider.</p>
<p>Now we can go back to our todo in <code>Gate::define()</code>.</p>
<h3><a id="defining-our-gates" href="#defining-our-gates" class="hidden" aria-hidden="true" title="Permalink"></a>Defining our Gates</h3>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$permissions</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">each</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">string</span><span style="color: #E1E4E8;"> $ident) {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #79B8FF;">Gate</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">define</span><span style="color: #E1E4E8;">($ident, </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> (</span><span style="color: #79B8FF;">User</span><span style="color: #E1E4E8;"> $user) </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;">($ident) {</span></div><div class='line'><span style="color: #E1E4E8;">        $cacheKey </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;user.&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> $user</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">id </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;.permissions&#39;</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">        $userPermissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Cache</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">get</span><span style="color: #E1E4E8;">($cacheKey);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">!</span><span style="color: #E1E4E8;"> $userPermissions) {</span></div><div class='line'><span style="color: #E1E4E8;">            $userClosure </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> ($query) </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> ($user) {</span></div><div class='line'><span style="color: #E1E4E8;">                $query</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;users.id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;=&#39;</span><span style="color: #E1E4E8;">, $user</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">id);</span></div><div class='line'><span style="color: #E1E4E8;">            };</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">            $userPermissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Permission</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">query</span><span style="color: #E1E4E8;">()</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">whereHas</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;roles&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> ($query) </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;">($userClosure) {</span></div><div class='line'><span style="color: #E1E4E8;">                                         $query</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;active&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;=&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">1</span><span style="color: #E1E4E8;">)</span></div><div class='line'><span style="color: #E1E4E8;">                                                      </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">whereHas</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;users&#39;</span><span style="color: #E1E4E8;">, $userClosure);</span></div><div class='line'><span style="color: #E1E4E8;">                                     });</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">orWhereHas</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;users&#39;</span><span style="color: #E1E4E8;">, $userClosure)</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">groupBy</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;permissions.id&#39;</span><span style="color: #E1E4E8;">)</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;active&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;=&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">1</span><span style="color: #E1E4E8;">)</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">pluck</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;ident&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">             </span><span style="color: #79B8FF;">Cache</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">put</span><span style="color: #E1E4E8;">($cacheKey, $userPermissions</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">toArray</span><span style="color: #E1E4E8;">());</span></div><div class='line'><span style="color: #E1E4E8;">         } </span><span style="color: #F97583;">else</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">             $userPermissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">collect</span><span style="color: #E1E4E8;">($userPermissions);</span></div><div class='line'><span style="color: #E1E4E8;">         }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">         </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($userPermissions) {</span></div><div class='line'><span style="color: #E1E4E8;">             $altPermissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">altPermissions</span><span style="color: #E1E4E8;">($ident);</span></div><div class='line'><span style="color: #E1E4E8;">             </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">null</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">!==</span><span style="color: #E1E4E8;"> $userPermissions</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">first</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">string</span><span style="color: #E1E4E8;"> $ident) </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;">($altPermissions) {</span></div><div class='line'><span style="color: #E1E4E8;">                 </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">\in_array</span><span style="color: #E1E4E8;">($ident, $altPermissions, </span><span style="color: #79B8FF;">true</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">             });</span></div><div class='line'><span style="color: #E1E4E8;">         }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">         </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">false</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">    });</span></div></code></pre>
<p>This has turned into quite a bit of code, so let me break this down for you.</p>
<p>First thing we're doing is setting the <code>$cacheKey</code> so that we can use the cached results of a user permissions. The reason for this is that we'll likely be checking for multiple permissions during the course of one single request, and we don't want to query the database every time.</p>
<p>The next part of the code goes on to retrieve the values and populate the cache if it isn't set. We're creating a <code>$userClosure</code> since the logic for the <code>roles.users</code> and <code>users</code> <code>whereHas</code> are the same, so rather that repeating ourselves we use a variable. What this query actually does, is grab all permissions that are associated with a role, that in turn is associated with the given user, as well as any that are associated directly to the user. We're grouping by <code>permissions.id</code> as we don't want repeat permissions, seeing that it's possible that one or more roles could have the same permission, or the user could have a direct permission that's also present in a role. The <code>pluck('ident')</code> method, tells it that we don't care about retrieving an instance of <code>Permission</code>, we just want the permission <code>ident</code>. Oh, and we're also only pulling those that are active, or belong to active roles.</p>
<p>We cache the value as an array, because our <code>pluck()</code> method returns an instance of <code>Illuminate\Support\Collection</code>, which is useful, but not for serialising. You'll also see that if we pulled the value from cache, we're transforming that to a collection.</p>
<p>Next we grab our alternative permissions using the methods we covered earlier, before cycling through the permission idents until we find one that is in our array. Once we do, we return it, whereby we immediately return whether or not the value is null. This will give us a nice boolean return, just like the <code>return false</code> we have at the bottom in case any of the above fails.</p>
<h1><a id="checking-users-permissions" href="#checking-users-permissions" class="hidden" aria-hidden="true" title="Permalink"></a>Checking users permissions</h1>
<p>Now that we have all the above in place, we can actually check whether or not a given user has the desired permission. We can do this by one several ways.</p>
<h3><a id="using-gate" href="#using-gate" class="hidden" aria-hidden="true" title="Permalink"></a>Using Gate</h3>
<p>To use Gate, we can simply do the following;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #79B8FF;">Gate</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">allows</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;blog.post.create&#39;</span><span style="color: #E1E4E8;">)) {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">...</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>If you wanted to check for multiple permissions, you can use <code>check()</code> to make sure they have all, or <code>any()</code> to see if they have at least one;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #79B8FF;">Gate</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">check</span><span style="color: #E1E4E8;">([</span><span style="color: #9ECBFF;">&#39;blog.post.create&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;blog.post.admin&#39;</span><span style="color: #E1E4E8;">])) {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">...</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>And</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #79B8FF;">Gate</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">any</span><span style="color: #E1E4E8;">([</span><span style="color: #9ECBFF;">&#39;blog.post.create&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;blog.post.admin&#39;</span><span style="color: #E1E4E8;">])) {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">...</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>There is also a <code>denies()</code> method on the gate, that just does the inverse of <code>allows()</code> so you can check that a user <em>DOESN'T</em> have the given permission. You can read the <a rel="noopener noreferrer" target="_blank" class="link link--external" href="https://laravel.com/docs/5.6/authorization#authorizing-actions-via-gates">Laravel docs</a> on dealing with Gates if you want to know anything further.</p>
<h3><a id="middleware" href="#middleware" class="hidden" aria-hidden="true" title="Permalink"></a>Middleware</h3>
<p>The middleware in question does actually use gate, but you don't. See the <a rel="noopener noreferrer" target="_blank" class="link link--external" href="https://laravel.com/docs/5.6/authorization#via-middleware">docs</a> on this. Just add the following to any routes you want protected;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$route</span><span style="color: #F97583;">-&gt;...-&gt;</span><span style="color: #B392F0;">middleware</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;can:blog.post.create&#39;</span><span style="color: #E1E4E8;">);</span></div></code></pre>
<h3><a id="controllers" href="#controllers" class="hidden" aria-hidden="true" title="Permalink"></a>Controllers</h3>
<p>If you're extending the default controller, which you most likely are, you have access to an <code>authorize()</code> method that you can use inside your controller actions;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">create</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">authorize</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;blog.post.create&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">...</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>
<p>Be aware that this will throw an exception in the form of <code>Illuminate\Auth\Access\AuthorizationException</code>. To read more about this, check the <a rel="noopener noreferrer" target="_blank" class="link link--external" href="https://laravel.com/docs/5.6/authorization#via-controller-helpers">docs</a>.</p>
<h3><a id="your-user-model" href="#your-user-model" class="hidden" aria-hidden="true" title="Permalink"></a>Your User model</h3>
<p>If you want to be able to check a users permissions directly from an instance of their user model you need to make sure that it implements the <code>Illuminate\Contracts\Auth\Access\Authorizable</code> contract, and uses the <code>Illuminate\Foundation\Auth\Access\Authorizable</code> trait. You'll have to import these classes as aliases since they have the same name and PHP won't let you do that. If you're using the default <code>User</code> model, or extending the one that comes with the <code>Auth</code> service (<code>Illuminate\Foundation\Auth\User</code>) this is already done for you, and you don't need to do anything to your model.</p>
<p>Once you have these in places, you can simply do;</p>
<pre><code data-theme="github-dark" data-lang="php" class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$user</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">can</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;blog.create.post&#39;</span><span style="color: #E1E4E8;">);</span></div></code></pre>
<p>You can read more about this in the <a rel="noopener noreferrer" target="_blank" class="link link--external" href="https://laravel.com/docs/5.6/authorization#via-the-user-model">docs</a>.</p>
<h1><a id="now-what" href="#now-what" class="hidden" aria-hidden="true" title="Permalink"></a>Now what?</h1>
<p>You now have a simple yet powerful RBAC for your Laravel application, so get to and create those permissions. Feel free to play around with the code as much as you please. Perhaps you don't like using dot notation? Perhaps you've a better idea about how to build up the alternative permission list? Well give them a go!</p>
<p>You'll notice that I haven't added anything about the creation of roles, permissions or their assignments. This is entirely up to you and would depend greatly on how your administration system works. Perhaps in the future I'll follow up with how to implement this with Nova, once it's finally released that is.</p>
<p>As always, let me know any feedback or questions you have.</p>
<p>As a side note, the comments are being replaced soon, as I've grown somewhat disenchanted with disqus, so I'm going to roll my own :P</p>
    </main>
</div>
</main>

    <!-- Fathom - beautiful, simple website analytics -->
    <script src="https://cdn.usefathom.com/script.js" data-site="THPWLTOW" defer></script>
    <!-- / Fathom -->

<script src="/assets/build/js/main.js?id=332d80b6520e8206b9564927e5f9bd73"></script>


</body>
</html>
