1691061160a:5:{s:7:"wrapped";s:9246:"<pre><code data-theme='github-dark' data-lang='php' class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$permissions</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">each</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">string</span><span style="color: #E1E4E8;"> $ident) {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #79B8FF;">Gate</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">define</span><span style="color: #E1E4E8;">($ident, </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> (</span><span style="color: #79B8FF;">User</span><span style="color: #E1E4E8;"> $user) </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;">($ident) {</span></div><div class='line'><span style="color: #E1E4E8;">        $cacheKey </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;user.&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> $user</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">id </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;.permissions&#39;</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">        $userPermissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Cache</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">get</span><span style="color: #E1E4E8;">($cacheKey);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">!</span><span style="color: #E1E4E8;"> $userPermissions) {</span></div><div class='line'><span style="color: #E1E4E8;">            $userClosure </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> ($query) </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> ($user) {</span></div><div class='line'><span style="color: #E1E4E8;">                $query</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;users.id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;=&#39;</span><span style="color: #E1E4E8;">, $user</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">id);</span></div><div class='line'><span style="color: #E1E4E8;">            };</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">            $userPermissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Permission</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">query</span><span style="color: #E1E4E8;">()</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">whereHas</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;roles&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> ($query) </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;">($userClosure) {</span></div><div class='line'><span style="color: #E1E4E8;">                                         $query</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;active&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;=&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">1</span><span style="color: #E1E4E8;">)</span></div><div class='line'><span style="color: #E1E4E8;">                                                      </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">whereHas</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;users&#39;</span><span style="color: #E1E4E8;">, $userClosure);</span></div><div class='line'><span style="color: #E1E4E8;">                                     });</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">orWhereHas</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;users&#39;</span><span style="color: #E1E4E8;">, $userClosure)</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">groupBy</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;permissions.id&#39;</span><span style="color: #E1E4E8;">)</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;active&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;=&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">1</span><span style="color: #E1E4E8;">)</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">pluck</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;ident&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">             </span><span style="color: #79B8FF;">Cache</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">put</span><span style="color: #E1E4E8;">($cacheKey, $userPermissions</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">toArray</span><span style="color: #E1E4E8;">());</span></div><div class='line'><span style="color: #E1E4E8;">         } </span><span style="color: #F97583;">else</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">             $userPermissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">collect</span><span style="color: #E1E4E8;">($userPermissions);</span></div><div class='line'><span style="color: #E1E4E8;">         }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">         </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($userPermissions) {</span></div><div class='line'><span style="color: #E1E4E8;">             $altPermissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">altPermissions</span><span style="color: #E1E4E8;">($ident);</span></div><div class='line'><span style="color: #E1E4E8;">             </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">null</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">!==</span><span style="color: #E1E4E8;"> $userPermissions</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">first</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">string</span><span style="color: #E1E4E8;"> $ident) </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;">($altPermissions) {</span></div><div class='line'><span style="color: #E1E4E8;">                 </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">\in_array</span><span style="color: #E1E4E8;">($ident, $altPermissions, </span><span style="color: #79B8FF;">true</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">             });</span></div><div class='line'><span style="color: #E1E4E8;">         }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">         </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">false</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">    });</span></div></code></pre>";s:11:"highlighted";s:9088:"<!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #E1E4E8;">$permissions</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">each</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">string</span><span style="color: #E1E4E8;"> $ident) {</span></div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #79B8FF;">Gate</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">define</span><span style="color: #E1E4E8;">($ident, </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> (</span><span style="color: #79B8FF;">User</span><span style="color: #E1E4E8;"> $user) </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;">($ident) {</span></div><div class='line'><span style="color: #E1E4E8;">        $cacheKey </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;user.&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> $user</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">id </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;.permissions&#39;</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">        $userPermissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Cache</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">get</span><span style="color: #E1E4E8;">($cacheKey);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">!</span><span style="color: #E1E4E8;"> $userPermissions) {</span></div><div class='line'><span style="color: #E1E4E8;">            $userClosure </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> ($query) </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> ($user) {</span></div><div class='line'><span style="color: #E1E4E8;">                $query</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;users.id&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;=&#39;</span><span style="color: #E1E4E8;">, $user</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">id);</span></div><div class='line'><span style="color: #E1E4E8;">            };</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">            $userPermissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Permission</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">query</span><span style="color: #E1E4E8;">()</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">whereHas</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;roles&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> ($query) </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;">($userClosure) {</span></div><div class='line'><span style="color: #E1E4E8;">                                         $query</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;active&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;=&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">1</span><span style="color: #E1E4E8;">)</span></div><div class='line'><span style="color: #E1E4E8;">                                                      </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">whereHas</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;users&#39;</span><span style="color: #E1E4E8;">, $userClosure);</span></div><div class='line'><span style="color: #E1E4E8;">                                     });</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">orWhereHas</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;users&#39;</span><span style="color: #E1E4E8;">, $userClosure)</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">groupBy</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;permissions.id&#39;</span><span style="color: #E1E4E8;">)</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">where</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;active&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #9ECBFF;">&#39;=&#39;</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">1</span><span style="color: #E1E4E8;">)</span></div><div class='line'><span style="color: #E1E4E8;">                                     </span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">pluck</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;ident&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">             </span><span style="color: #79B8FF;">Cache</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">put</span><span style="color: #E1E4E8;">($cacheKey, $userPermissions</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">toArray</span><span style="color: #E1E4E8;">());</span></div><div class='line'><span style="color: #E1E4E8;">         } </span><span style="color: #F97583;">else</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">             $userPermissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">collect</span><span style="color: #E1E4E8;">($userPermissions);</span></div><div class='line'><span style="color: #E1E4E8;">         }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">         </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($userPermissions) {</span></div><div class='line'><span style="color: #E1E4E8;">             $altPermissions </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">altPermissions</span><span style="color: #E1E4E8;">($ident);</span></div><div class='line'><span style="color: #E1E4E8;">             </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">null</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">!==</span><span style="color: #E1E4E8;"> $userPermissions</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">first</span><span style="color: #E1E4E8;">(</span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">string</span><span style="color: #E1E4E8;"> $ident) </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;">($altPermissions) {</span></div><div class='line'><span style="color: #E1E4E8;">                 </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">\in_array</span><span style="color: #E1E4E8;">($ident, $altPermissions, </span><span style="color: #79B8FF;">true</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">             });</span></div><div class='line'><span style="color: #E1E4E8;">         }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">         </span><span style="color: #F97583;">return</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">false</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #E1E4E8;">    });</span></div>";s:6:"styles";s:65:"background-color: #24292e; --theme-selection-background: #39414a;";s:7:"classes";s:10:"torchlight";s:5:"attrs";a:2:{s:10:"data-theme";s:11:"github-dark";s:9:"data-lang";s:3:"php";}}