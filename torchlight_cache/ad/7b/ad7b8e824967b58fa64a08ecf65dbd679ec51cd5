1691061158a:5:{s:7:"wrapped";s:10399:"<pre><code data-theme='github-dark' data-lang='php' class='torchlight' style='background-color: #24292e; --theme-selection-background: #39414a;'><!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">namespace</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">App\Jobs</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Services\TenantManager</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Tenant</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Bus\Queueable</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Contracts\Queue\ShouldQueue</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Foundation\Bus\Dispatchable</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Queue\InteractsWithQueue</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">class</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">SetupAccountDatabase</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">implements</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">ShouldQueue</span><span style="color: #E1E4E8;"> {</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Dispatchable</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">InteractsWithQueue</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">Queueable</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $tenant;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $tenantManager;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">__construct</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">Tenant</span><span style="color: #E1E4E8;"> $tenant, </span><span style="color: #79B8FF;">TenantManager</span><span style="color: #E1E4E8;"> $tenantManager) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant        </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $tenant;</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $tenantManager;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">handle</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        $database    </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;tenant_&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">id;</span></div><div class='line'><span style="color: #E1E4E8;">        $connection  </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">\DB</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">connection</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">        $createMysql </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $connection</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">statement</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;</span><span style="color: #F97583;">CREATE</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">DATABASE</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> $database);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($createMysql) {</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setTenant</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant);</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">\DB</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">connection</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">purge</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">migrate</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">        } </span><span style="color: #F97583;">else</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">            $connection</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">statement</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;DROP DATABASE &#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> $database);</span></div><div class='line'><span style="color: #E1E4E8;">        }</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">private</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">migrate</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        $migrator </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">app</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;migrator&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">        $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setConnection</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">!</span><span style="color: #E1E4E8;"> $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">repositoryExists</span><span style="color: #E1E4E8;">()) {</span></div><div class='line'><span style="color: #E1E4E8;">            $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">getRepository</span><span style="color: #E1E4E8;">()</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">createRepository</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">        }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">run</span><span style="color: #E1E4E8;">(</span><span style="color: #B392F0;">database_path</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;migrations/tenants&#39;</span><span style="color: #E1E4E8;">), []);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div></code></pre>";s:11:"highlighted";s:10241:"<!-- Syntax highlighted by torchlight.dev --><div class='line'><span style="color: #F97583;">namespace</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">App\Jobs</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Services\TenantManager</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">App\Tenant</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Bus\Queueable</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Contracts\Queue\ShouldQueue</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Foundation\Bus\Dispatchable</span><span style="color: #E1E4E8;">;</span></div><div class='line'><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Illuminate\Queue\InteractsWithQueue</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #F97583;">class</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">SetupAccountDatabase</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">implements</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">ShouldQueue</span><span style="color: #E1E4E8;"> {</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">use</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">Dispatchable</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">InteractsWithQueue</span><span style="color: #E1E4E8;">, </span><span style="color: #79B8FF;">Queueable</span><span style="color: #E1E4E8;">;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $tenant;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">protected</span><span style="color: #E1E4E8;"> $tenantManager;</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">__construct</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">Tenant</span><span style="color: #E1E4E8;"> $tenant, </span><span style="color: #79B8FF;">TenantManager</span><span style="color: #E1E4E8;"> $tenantManager) {</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant        </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $tenant;</span></div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $tenantManager;</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">public</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">handle</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        $database    </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;tenant_&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">id;</span></div><div class='line'><span style="color: #E1E4E8;">        $connection  </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #79B8FF;">\DB</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">connection</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">        $createMysql </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> $connection</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">statement</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;</span><span style="color: #F97583;">CREATE</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">DATABASE</span><span style="color: #E1E4E8;"> </span><span style="color: #9ECBFF;">&#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> $database);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> ($createMysql) {</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenantManager</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setTenant</span><span style="color: #E1E4E8;">(</span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #E1E4E8;">tenant);</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">\DB</span><span style="color: #F97583;">::</span><span style="color: #B392F0;">connection</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">)</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">purge</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">            </span><span style="color: #79B8FF;">$this</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">migrate</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">        } </span><span style="color: #F97583;">else</span><span style="color: #E1E4E8;"> {</span></div><div class='line'><span style="color: #E1E4E8;">            $connection</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">statement</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;DROP DATABASE &#39;</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">.</span><span style="color: #E1E4E8;"> $database);</span></div><div class='line'><span style="color: #E1E4E8;">        }</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">    </span><span style="color: #F97583;">private</span><span style="color: #E1E4E8;"> </span><span style="color: #F97583;">function</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">migrate</span><span style="color: #E1E4E8;">() {</span></div><div class='line'><span style="color: #E1E4E8;">        $migrator </span><span style="color: #F97583;">=</span><span style="color: #E1E4E8;"> </span><span style="color: #B392F0;">app</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;migrator&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'><span style="color: #E1E4E8;">        $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">setConnection</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;tenant&#39;</span><span style="color: #E1E4E8;">);</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        </span><span style="color: #F97583;">if</span><span style="color: #E1E4E8;"> (</span><span style="color: #F97583;">!</span><span style="color: #E1E4E8;"> $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">repositoryExists</span><span style="color: #E1E4E8;">()) {</span></div><div class='line'><span style="color: #E1E4E8;">            $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">getRepository</span><span style="color: #E1E4E8;">()</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">createRepository</span><span style="color: #E1E4E8;">();</span></div><div class='line'><span style="color: #E1E4E8;">        }</span></div><div class='line'>&nbsp;</div><div class='line'><span style="color: #E1E4E8;">        $migrator</span><span style="color: #F97583;">-&gt;</span><span style="color: #B392F0;">run</span><span style="color: #E1E4E8;">(</span><span style="color: #B392F0;">database_path</span><span style="color: #E1E4E8;">(</span><span style="color: #9ECBFF;">&#39;migrations/tenants&#39;</span><span style="color: #E1E4E8;">), []);</span></div><div class='line'><span style="color: #E1E4E8;">    }</span></div><div class='line'><span style="color: #E1E4E8;">}</span></div>";s:6:"styles";s:65:"background-color: #24292e; --theme-selection-background: #39414a;";s:7:"classes";s:10:"torchlight";s:5:"attrs";a:2:{s:10:"data-theme";s:11:"github-dark";s:9:"data-lang";s:3:"php";}}